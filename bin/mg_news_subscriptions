#!/usr/bin/python2.6

from mg.core import Instance
from mg.web import WebDaemon
from concurrence import dispatch, quit
from mg.cass import CassandraPool
import traceback
import json
from cassandra.ttypes import *

def main():
    try:
        inst = Instance()
        daemon = WebDaemon(inst)
        conf = daemon.download_config()
        dbpool = CassandraPool(conf["cassandra"])
        db = dbpool.dbget("metagam")
        res = db.multiget_slice(["NewsSubscriptions"], ColumnParent(column_family="Core"), SlicePredicate(slice_range=SliceRange(start="", finish="")), ConsistencyLevel.ALL)
        for col in res["NewsSubscriptions"]:
            info = json.loads(col.column.value)
            lang = info.get("lang")
            if lang is None:
                lang = "en"
            print "%s\t%s" % (col.column.name, lang)
    except SystemExit:
        quit(0)
    except RuntimeError as e:
        print e
        quit(1)
    except:
        traceback.print_exc()
        quit(1)
    quit(0)

dispatch(main)

