#!/usr/bin/python2.6

from mg.core import Instance, ApplicationFactory
from mg.core.web import WebDaemon, WebApplication
from concurrence import dispatch, Tasklet
from mg.core.cass import CassandraPool
from mg.core.memcached import MemcachedPool, Memcached
import traceback
import json
import logging

def main():
    try:
        inst = Instance()
        inst.set_server_id("director");
        dbpool = CassandraPool((("director-db", 9160),))
        mcpool = MemcachedPool(("director-mc", 11211))
        # application
        app = WebApplication(inst, dbpool, mcpool, "int", "int")
        app.modules.load(["mg.core.director.CassandraStruct"])
        app.dbrestruct()
        app.modules.load(["mg.core.director.Director"])
        # web daemon
        daemon = WebDaemon(inst)
        daemon.app = app
        port = daemon.serve(("0.0.0.0", 3000))
        # application factory
        inst.appfactory = ApplicationFactory(inst)
        inst.appfactory.add(app)
        inst.int_app = app
        # run
        Tasklet.new(monitor)(app)
        Tasklet.new(app.hooks.call)("queue.process")
        while True:
            try:
                app.hooks.call("core.fastidle")
            except:
                traceback.print_exc()
            Tasklet.sleep(1)
    except RuntimeError as e:
        logging.error(e)
        quit(1)
    except BaseException as e:
        logging.exception(e)
        quit(1)

def monitor(app):
    while True:
        try:
            app.hooks.call("monitor.check")
        except:
            traceback.print_exc()
        Tasklet.sleep(10)

dispatch(main)

