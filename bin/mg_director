#!/usr/bin/python2.6

from mg.core import Instance
from mg.web import WebDaemon, WebApplication
from concurrence import dispatch
from mg.cass import DatabasePool
from mg.memcached import MemcachedPool, Memcached
import traceback
import json
import logging

def main():
    try:
        inst = Instance()
        inst.server_id = 'director';
        daemon = WebDaemon(inst)
        dbpool = DatabasePool((("director-db", 9160),))
        mc = Memcached(MemcachedPool(("director-mc", 11211)), prefix="mg_")
        app = WebApplication(inst, dbpool, "metagam", mc, "int")
        daemon.app = app
        app.modules.load(["mg.director.DatabaseStruct"])
        app.dbrestruct()
        app.modules.load(["mg.director.Director"])
        port = daemon.serve(("0.0.0.0", 3000))
    except RuntimeError as e:
        logging.error(e)
        quit(1)
    except BaseException as e:
        logging.exception(e)
        quit(1)

dispatch(main)

