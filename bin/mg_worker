#!/usr/bin/python2.6

from mg.core import Instance
from mg.core.web import WebDaemon, WebApplication
from mg.core.worker import MultiapplicationWebDaemon, ApplicationFactory
from concurrence import dispatch
from mg.core.cass import CassandraPool
from mg.core.memcached import MemcachedPool, Memcached
import traceback
import json
import mg.core.cluster
import sys

def main():
    try:
        inst = Instance()

        # Running internal daemon
        int_daemon = WebDaemon(inst)
        conf = int_daemon.download_config()
        dbpool = CassandraPool(conf["cassandra"])
        mcpool = MemcachedPool(conf["memcached"][0])
        int_mc = Memcached(mcpool, prefix="mg_")
        int_app = WebApplication(inst, dbpool, "metagam", int_mc, "int", "mg_")
        int_daemon.app = int_app
        int_app.modules.load(["mg.core.worker.Worker"])
        int_port = int_daemon.serve_any_port("0.0.0.0")

        # Running external daemon
        ext_daemon = MultiapplicationWebDaemon(inst, dbpool, mcpool)
        ext_port = ext_daemon.serve_any_port("0.0.0.0")

        # Application factory
        inst.appfactory = ApplicationFactory(inst, dbpool, mcpool)
        inst.appfactory.add_permanent(int_app)

        # Registering
        res = mg.core.cluster.dir_query("/director/ready", {
            "type": "worker",
            "port": int_port,
            "id": sys.argv[1],
            "params": json.dumps({
                "ext_port": ext_port,
            }),
        })
        inst.server_id = res["server_id"]
    except RuntimeError as e:
        print e
        quit(1)
    except:
        traceback.print_exc()
        quit(1)

dispatch(main)

