#!/usr/bin/python2.6
# -*- coding: utf-8 -*-

from mg import *
from concurrence import dispatch, quit
import os
import logging
import sys
import json
import re
import time

key_cache_size = 5000
key_cache_save_period_in_seconds = 1800
memtable_throughput_in_mb = 1
memtable_operations_in_millions = 500 / 1e6

def main():
    try:
        if len(sys.argv) != 2:
            print "usage: mg_db_configure <keyspace>"
            os._exit(1)
        inst = Instance("db_cleanup")
        inst.download_config()
        mc = Memcached(inst.mcpool)
        db = inst.dbpool.dbget("main", mc)
        for cfdef in db.describe_keyspace(sys.argv[1]).cf_defs:
            changed = False
            if cfdef.key_cache_size != key_cache_size:
                cfdef.key_cache_size = key_cache_size
                changed = True
            if cfdef.key_cache_save_period_in_seconds != key_cache_save_period_in_seconds:
                cfdef.key_cache_save_period_in_seconds = key_cache_save_period_in_seconds
                changed = True
            if cfdef.memtable_throughput_in_mb != memtable_throughput_in_mb:
                cfdef.memtable_throughput_in_mb = memtable_throughput_in_mb
                changed = True
            if cfdef.memtable_operations_in_millions != memtable_operations_in_millions:
                cfdef.memtable_operations_in_millions = memtable_operations_in_millions
                changed = True
            if changed:
                print "updating %s.%s" % (cfdef.keyspace, cfdef.name)
                db.system_update_column_family(cfdef)
        sys.stdout.flush()
        os._exit(0)
    except RuntimeError as e:
        logging.error(e)
        os._exit(1)
    except Exception as e:
        logging.exception(e)
        os._exit(1)

dispatch(main)

