#!/usr/bin/python2.6
# -*- coding: utf-8 -*-

from mg import *
from concurrence import dispatch, quit
from mg.core.projects import ProjectList
from mg.core.modifiers import *
from mg.constructor.common import ApplicationFactory
import os
import logging
import sys

def main():
    try:
        inst = Instance("users")
        inst.download_config()
        int_app = WebApplication(inst, "int", "int")
        int_app.modules.load(["mg.core.worker.Worker", "mg.constructor.admin.Constructor"])
        inst.int_app = int_app
        appfactory = ApplicationFactory(inst)
        appfactory.add(int_app)
        inst.appfactory = appfactory
        lst = int_app.objlist(ProjectList, query_index="created")
        lst.load(silent=True)
        for ent in lst:
            name = ent.get("title_short")
            if name:
                name = u"%s: %s" % (ent.uuid, name)
                name = name.encode("utf-8")
                app = appfactory.get_by_tag(ent.uuid)
                if app:
                    modlst = app.objlist(DBModifierList, query_index="till")
                    modlst.load(silent=True)
                    for mod in modlst:
                        print u"%s: %s" % (name, mod.data)
                        mods = MemberModifiers(app, mod.get("target_type"), mod.get("target"))
                        kind = mod.get("kind")
                        value = mod.get("value")
                        till = mod.get("till")
                        del mod.data["target_type"]
                        del mod.data["target"]
                        del mod.data["value"]
                        del mod.data["till"]
                        mods.add(kind, value, till, **mod.data)
                        mod.remove()
                else:
                    print "Couldn't load application %s" % ent.uuid
        sys.stdout.flush()
        os._exit(0)
    except RuntimeError as e:
        logging.error(e)
        os._exit(1)
    except Exception as e:
        logging.exception(e)
        os._exit(1)

dispatch(main)

