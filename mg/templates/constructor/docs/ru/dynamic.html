<!-- doc.title Параметры, изменяющиеся со временем -->
<!-- doc.parent parameters -->
<!-- doc.keywords параметры персонажа, параметры в онлайн-игре, изменяюжиеся со временем -->
<!-- doc.description Статья об устройве параметров объектов, изменяющихся со временем, в конструкторе онлайн-игр MMO Constructor -->

<h1>Параметры, изменяющиеся со временем</h1>

<p>Зачастую у администратора игры возникает необходимость задать значение параметра, которое не статично, а изменяется с течением времени. Например, это может быть восстановление жизни персонажа, уменьшение запаса дыхательной смеси под водой, траектория движения предмета и т.д.</p>

<p>Значение такого параметра меняется очень часто, и если при каждом изменении сохранять его в базу данных, то база будет сильно перегружена. Если при каждом изменении передавать его по сети пользователям в клиенты, то сильно перегружена будет сеть.</p>

<p>Решение проблемы заключается в том, что администратор игры задаёт значение параметра в виде функции от времени t. И именно в виде функции это значение сохраняется в базе данных и пересылается клиентам. Такой подход позволяет вычислить точное значение параметра в любой момент времени без дорогостоящих обращений к дискам и сети.</p>

<p>Для того, чтобы было возможно вычислять взаимно согласованные значения как на сервере, так и на клиенте, они должны иметь <a href="/time">синхронизированные счётчики времени</a>.</p>

<h1>Задание значений параметрам</h1>

<p>Для того, чтобы <a href="/doc/parameters">параметр объекта</a> (персонажа, локации, предмета) начал изменяться со временем, необходимо либо задать его значение через административный интерфейс (где это уместно), либо воспользоваться одной из двух функций <a href="/doc/quest">квестового MMOScript</a> &mdash; "set dynamic" или "slide", либо вручную задать значения в клиенте.</p>

<ul>
    <li>Динамические координаты <a href="/doc/location-objects">объектов на локациях</a> могут задаваться либо через административный интерфейс, либо чеоез JavaScript API на клиенте;</li>
    <li><a href="/doc/parameters">параметры персонажей, локаций и типов предметов</a> могут задаваться либо через административный интерфейс, либо через квестовый движок;</li>
    <li><a href="/doc/design/progress">прогресс-бары</a> автоматически подгружают динамические значения из соответствующих параметров персонажа;</li>
    <li><a href="#">динамические блоки</a> также автоматически используют динамические параметры персонажа.</li>
</ul>

<h1>Поддержка параметров, изменяющихся со временем, в движке квестов и триггеров</h1>

<p>Инструкция "slide" квестового движка предоставляет простой способ задать плавное изменение параметра от одного значения до другого:</p>
<pre class="doc-code-sample">
slide <strong>объект</strong>.<strong>параметр</strong> [from=<strong>выражение</strong>] to=<strong>выражение</strong> time=<strong>выражение</strong> [round=<strong>выражение</strong>]
</pre>
<p>Эта команда задаёт динамическое значение параметру, который будет в течение time секунд плавно линейно изменяться от значения from до значения to. Если значение from не задано, то в качестве начального значения будет взято текущее значение параметра.</p>
<p>Если аргумент round не задан, то значение будет изменяться плавно. Если задан, то каждое мгновенное значение будет округляться до кратного round. Например, если задать round=1, то значения параметра будут изменяться ступеньками по целым числам.</p>
<p>Например, чтобы запустить восстановление жизни персонажа по 3 единицы в секунду ступеньками по 0.1 HP:</p>
<pre class="doc-code-sample">
slide char.p_hp from=char.p_hp to=char.p_max_hp time=(char.p_max_hp - char.p_hp) / 3 round=0.1
</pre>

<p>Более гибкий доступ к заданию параметра, изменяющегося со временем, предоставляет инструкция "set dynamic":</p>
<pre class="doc-code-sample">
set dynamic <strong>объект</strong>.<strong>параметр</strong> = <strong>выражение</strong> [till=<strong>выражение</strong>]
</pre>
<p>Выражение в этом случае должно содержать переменную t, которая представляет собой счётчик времени, засинхронизированный между клиентом и сервером. Подробная информация о параметрах, изменяющихся со временем, приведена в <a href="/dynamic">одноименном разделе</a>.</p>
<p>Технически в момент выполнения этой операции происходит <a href="/doc/script#conversions">частичное вычисление</a> значения выражения.</p>
<p>Чтобы использовать в выражении значение счётчика времени на момент выполнения этой команды, используйте переменную T (большое).</p>
<p>Пример:</p>
<pre class="doc-code-sample">
set dynamic char.p_xp = 10 + sin(t - T) * 5
</pre>
<p>У команды есть необязательный аргумент till. Если он не задан, то динамическое значение параметра будет работать неограниченно долго. Если его задать, то выражение остановится на указанном моменте времени. То есть, если t &gt; till, то при вычислении значения выражения вместо t будет подставляться till.</p>

<h1>Поддержка параметров, изменяющихся со временем, на стороне JavaScript-клиента</h1>

<p>Все параметры персонажа, которым управляет игрок, и которые ему видимы, доставляются в клиент. Этот процесс описан в разделе "<a href="/character-delivery">Доставка параметров персонажей в клиент</a>". Вычисляемые параметры в клиент не доставляются и в браузере недоступны.</p>

<p>В клиент доставляются как статические значения параметров, так и изменяемые со временем. Если вы хотите отображать значения параметров в клиенте, то имеет смысл подписаться на событие "параметры изменились" и получать уведомления обо всех изменившихся значениях. Если параметр динамический, то событие будет срабатывать многократно, доставляя актуальные значения в обработчик.</p>

<p>Для того, чтобы обрабатывать события, подключите свой обработчик на JavaScript:</p>
<pre class="doc-code-sample">
Characters.onParamChange = function (changes) {
    if (changes.hasOwnProperty('hp') || changes.hasOwnProperty('max_hp')) {
        var hp = Characters.myParam('hp');
        var max_hp = Characters.myParam('max_hp');
        // здесь можно обновить на экране текущие значения hp и max_hp.
    }
};
</pre>

<p>Функция-обработчик получает в качестве параметра объект "changes", каждое поле которого &mdash; это код параметра и его значение. Кроме того, в любой момент можно обратиться к функции Characters.myParam(), передав ей код параметра. Она возвращает его текущее мгновенное значение.</p>

<p>Устанавливать код обработчика удобно через интерфейс настройки <a href="/doc/design/gameinterface#javascript">произвольных скриптов</a> игрового интерфейса.</p>

<a name="DynamicValue"></a>
<h1>Класс DynamicValue</h1>

<p>JavaScript API предоставляет удобный класс для хранения значения параметра (как статического, так и динамического). Это класс DynamicValue. Чтобы создать экземпляр, необходимо передать конструктору либо статическое значение, либо формулу для значения, изменяемого с течением времени:</p>
<pre class="doc-code-sample">
var st = DynamicValue(123);
var dyn = DynamicValue(['+', 2, ['func', 'call', 'sin', ['glob', 't']]]); // 2 + sin(t)
</pre>

<p>Если значение должно изменяться не вечно, а до какого-то фиксированного момента времени, то необходимо вызвать метод setTill и задать момент времени, когда надо остановиться. Например, через 5 секунд:</p>
<pre class="doc-code-sample">
dyn.setTill(TimeSync.getTime() + 5);
</pre>

<p>После того, как объект создан, можно в любой момент получить его значение на указанный момент времени:</p>
<pre class="doc-code-sample">
var stVal = st.evaluate(t);
var dynVal = dyn.evaluate(t);
</pre>

<p>Если у динамического значения задано время окончания действия, то по прошествии этого времени хранить формулу и вычислять её каждый раз необходимости нет. Можно её "забыть" и считать это значение статическим. Необходимость такого метода вызвана тем, что как только значение стало статическим, можно перестать его регулярно вычислять, например, для обновления чего-либо на экране. Чтобы попросить DynamicValue забыть формулу, если после момента t она уже не действует, необходимо вызвать метод forget:</p>
<pre class="doc-code-sample">
dyn.forget(t);
</pre>

<p>Либо можно совместить получение значения на момент времени t и забывание формулы, если её действие кончилось раньше этого t:</p>
<pre class="doc-code-sample">
var dynVal = dyn.evaluateAndForget(t);
</pre>

<a name="blocks"></a>
<h1>Динамические блоки интерфейса</h1>

<p>Система имеет возможность автоматически обновлять содержимое DOM-элементов в игровом интерфейсе при изменении параметров персонажа, доставляемых в клиент. Для этого предназначен механизм динамических блоков. Его настройки осуществляются через меню "Интерфейс игры / Динамические блоки":</p>

<img class="doc-screenshot" src="/st/tutorial/dynblocks-1.png" alt="" />

<p>При нажатии на ссылки "Новый динамический блок" или "редактировать" открывается диалог редактирования параметров динамического блока:</p>

<img class="doc-screenshot" src="/st/tutorial/dynblocks-2.png" alt="" />

<ul>
    <li>CSS-селектор &mdash; это CSS-selector, который определяет элементы, в которые необходимо записать контент. Если таких элементов окажется несколько, то обновлены будут все. Поддерживаются селекторы, начинающиеся с точки (имена классов) и с решётки (идентификаторы элементов);</li>
    <li>Содержимое блока &mdash; это текстовое выражение MMOScript, которое вычисляется на стороне клиента. Ему доступен объект "char", представляющий текущего персонажа. У персонажа доступны не все поля, а только id (идентификатор персонажа), name (его имя) и параметры p_..., которые доставляются в клиент (т.е. только параметры, видимые владельцу).</li>
</ul>
