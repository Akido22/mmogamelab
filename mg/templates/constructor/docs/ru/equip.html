<!-- doc.title Система экипировки персонажей в конструкторе игр -->
<!-- doc.parent index -->
<!-- doc.keywords предметы, инвентарь, надеть, снять, экипировка, онлайн-игры -->
<!-- doc.description Описание работы системы экипировки в конструкторе онлайн-игр -->

<h1>Система экипировки персонажей</h1>

<p>Система экипировки персонажей позволяет администраторам онлайн-игр настраивать слоты экипировки у персонажей и даёт возможность помещать в них предметы.</p>

<p>Чтобы в игре появилась система экипировки, вам необходимо подключить <a href="/doc/modules">системные модули</a> "Система инвентаря" и "Экипировка персонажей". После этого в административном интерфейсе появится меню "Инвентарь / Экипировка", через который настраивается основная часть системы.</p>

<h1>Настройка списка слотов</h1>

<p>Первый шаг в настройке системы экипировки &mdash; это настройка списка слотов, которые имеются у персонажа. Администратор может создать произвольное количество слотов. Ограничений на количество нет, однако помните, что не у всех игроков 27-дюймовые мониторы, и лучше сделать интерфейс покомпактнее. Список слотов настраивается в меню "Инвентарь / Экипировка / Слоты экипировки": <img class="doc-screenshot" src="/st/tutorial/equip-1.png" alt="" /></p>

<p>Слоты можно удалять. Однако делать этого не рекомендуется, поскольку в них могут находиться предметы игроков, и они могут оказаться заблокированными.</p>

<p>Для каждого слота администратор должен заполнить следующую форму: <img class="doc-screenshot" src="/st/tutorial/equip-2.png" alt="" /></p>

<ul>
	<li>ID слота &mdash; это уникальное целое число, которое будет использоваться при отображении слотов в редакторе разметки, а также, например, в скриптовом движке:<pre class="doc-code-sample">char.equip.slot7</pre>Диапазон значений идентификаторов &mdash; от 1 до 100;</li>
	<li>порядок сортировки определяет, в каком порядке слоты отображаются в административном интерфейсе, а также в каком порядке они будут заполняться при нажатии на кнопку "Надеть" на предметах;</li>
	<li>название слота кратко описывает его тип, а описание &mdash; подробный текст, описывающий назначение слота при наведении на него мыши;</li>
	<li>условие видимости &mdash; <a href="/doc/script">скриптовое выражение</a>, описывающее, в каком случае слот будет виден. К примеру, это условие можно использовать, чтобы слот становился доступным при достижении какого-то уровня или при подписке на премиум-услугу;</li>
	<li>условие доступности &mdash; если слот видим, то можно сделать его доступным, а можно недоступным. Если слот недоступен, то он отображается серым цветом и вставить в него предметы нельзя;</li>
	<li>галочки видимости в интерфейсах предоставляют возможность администратору задать, будет ли слот доступен самому персонажу через его внутриигровую страницу персонажа и будет ли он видим всем остальным игрокам через публичную странифу информации персонажа;</li>
	<li>если администратор установил галочку видимости, то необходимо ввести размеры слота в пикселях для этого интерфейса. Рекомендуется устанавливать размеры всех слотов, кратными какому-либо фиксированному размеру сетки &mdash; например, 5 или 10 пикселей. При выполнении этого условия будет проще размещать слоты в визуальном редакторе.</li>
</ul>

<p>Обратите внимание, что если в слот вставлен какой-то предмет, то он будет видим независимо от условий видимости и доступности. Как только предмет оттуда игрок снимет, слот станет невидимым или недоступным, в зависимости от условий.</p>

<h1>Разметка экипировки</h1>

<p>После того, как список слотов задан, администратору необходимо создать визуальное представление "аватара" персонажа. Здесь под аватаром подразумевается образ персонажа и слоты вокруг него. Это делается через меню "Инвентарь / Экипировка / Разметка экипировки". Оттуда необходимо зайти в каждый из интерфейсов и отредактировать его при помощи специального редактора: <img class="doc-screenshot" src="/st/tutorial/equip-3.png" alt="" /></p>

<ul>
	<li>Галочка "Включить сетку" позволяет активировать сетку, по которой будут перемещаться все объекты;</li>
	<li>размер сетки &mdash; целое число пикселей, не более 50;</li>
	<li>рамка слотов &mdash; толщина рамки вокруг слота в пикселях;</li>
	<li>рамка образа персонажа &mdash; толщина рамки в пикселях вокруг образа персонажа.</li>
</ul>

<p>Расставлять элементы можно в любом месте поля. Система автоматически откадрирует разметку в прямоугольник минимального размера. К примеру, приведённая выше разметка будет формировать такую страницу персонажа: <img class="doc-screenshot" src="/st/tutorial/equip-5.png" alt="" /></p>

<h2>Использование редактора</h2>

<p>Элементы перемещаются по полю при помощи мыши. Если нужно более точное перемещение, чем позволяет сетка, можно либо отключить её, либо воспользоваться клавишами стрелок на клавиатуре. Их нажатие будет перемещать подсвеченный элемент по 1 пикселю в соответствующую сторону.</p>

<p>Если к вашей игре подключен модуль <a href="/doc/storage">Статическое хранилище</a>, то при помощи кнопки "Добавить произвольное изображение" можно загрузить любое изображение и разместить его на поле: <img class="doc-screenshot" src="/st/tutorial/equip-4.png" alt="" /></p>
<p>При помощи этой функции можно помещать в разметку элементы пользовательского оформления. Чтобы удалить изображение, наведите на него курсор мыши и нажмите на клавиатуре кнопку "Delete".</p>

<p>Изображения отображаются послойно. В самом низу находятся произвольные изображения &mdash; они формируют фон. Изображения показываются в порядке добавления (самые свежие &mdash; сверху). Затем сверху накладывается аватар персонажа. И на самом верху отображаются слоты. Этот порядок строго соблюдается как в редакторе разметки, так и в пользовательских интерфейсах.</p>

<p>Если вы удалите с поля картинку, она автоматически не удалится из хранилища. Чтобы не замусоривать сервер, рекомендуется зайти в административный интерфейс статического хранилища и удалить лишние изображения.</p>

<h1>Создание предметов экипировки</h1>

<p>После того, как слоты и их разметка созданы, администратор может создать предметы, надеваемые в эти слоты. Это делается через обычный редактор предметов в меню "Инвентарь / Типы предметов". После того, как игре будет подключен модуль экипировки, в редакторе предмета появится новый раздел "Экипировка", в котором можно установить галочку "Предмет надеваемый" и задать ему характерстики: <img class="doc-screenshot" src="/st/tutorial/equip-6.png" alt="" /></p>
<ul>
	<li>Скриптовое условие для кнопки "Надеть" позволяет включать и отключать эту кнопку на предметах. Если кнопка отсутствует, то предмет всё равно может быть надет через клик на свободный слот;</li>
	<li>галочки напротив названий слотов позволяют указать, в какие слоты данный предмет может быть вставлен;</li>
	<li>в разделе "Требования" можно указать минимальные значения параметров персонажа, которые позволят ему надеть этот предмет. Если поле не заполнено, значит ограничений на значение параметра нет.</li>
</ul>

<h1>Пользовательские интерфейсы</h1>

<p>Игроку доступны следующие возможности:</p>
<ul>
	<li>при нажатии на пустой слот выбрать подходящий предмет и надеть его;</li>
	<li>при нажатии на заполенный слот снять предмет;</li>
	<li>в интерфейсе инвентаря нажать на кнопку "Надеть", и предмет сам наденется на персонажа.</li>
</ul>

<p>Последнюю возможность следует рассмотреть подробнее. Если на персонаже найдётся пустой слот, подходящий для предмета, то предмет будет вставлен в него. Если пустых слотов несколько, то будет выбран слот с наименьшим порядком сортировки. Если все подходящие слоты заняты, то один из предметов будет снят и на его место надет новый. Чтобы определить, какой из предметов снять, система загружает балансировочную цену каждого из предметов и выбирает самый дешёвый предмет. Система никогда не заменит новым предметом старый предмет такого же типа (независимо от того, отличаются они по ДНК или нет).</p>

<p>При сравнении цен в разных валютах система использует курсы валют, задаваемые через <a href="/doc/currency-rates">Систему настройки курсов валют</a>.</p>

<p>Если подходящего слота не нашлось, то игроку будет показано сообщение об этом.</p>

<h1>Скриптовый доступ к системе экипировки</h1>

<p>У предметов (ItemType) появляется атрибут "equip", который равен 1, если предмет надеваемый и 0, если не надеваемый. Пример использования: <pre class="doc-code-sample">item.equip</pre></p>
<p>У персонажа (Character) появляется атрибут "equip", который представляет собой объект CharacterEquip, описывающий экипировку этого персонажа.</p>

<a name="object"></a>
<h2>Объект CharacterEquip</h2>

<p>Объект CharacterEquip предоставляет доступ через скриптовый движок к параметрам экипировки персонажа:</p>
<ul>
	<li>max_<strong>параметр</strong> &mdash; максимальное значение параметра "<strong>параметр</strong>", какое только встречается у надетых предметов;</li>
	<li>min_<strong>параметр</strong> &mdash; минимальное значение параметра "<strong>параметр</strong>";</li>
	<li>sum_<strong>параметр</strong> &mdash; суммарное значение параметра "<strong>параметр</strong>" у всех надетых предметов;</li>
	<li>cnt_<strong>тип</strong> &mdash; количество предметов типа "<strong>тип</strong>", надетых на персонажа (независимо от того, имеют они модификации или нет);</li>
	<li>cnt_dna_<strong>ДНК</strong> &mdash; количество предметов с ДНК, в точности равным "<strong>ДНК</strong>", надетых на персонажа;</li>
	<li>slot<strong>ID</strong> &mdash; предмет, надетый в слот с идентификатором <strong>ID</strong> или пустое значение, если ничего не надето.</li>
</ul>

<h1>Как сделать, чтобы надетая экипировка увеличивала характеристики персонажа</h1>

<p>Увеличить можно только параметры персонажа, которые заданы в виде вычисляемого выражения. Параметры, хранимые в базе данных, увеличить надетой экипировкой нельзя.</p>

<p>К примеру, рассмотрим параметр персонажа "Сила", который у голого персонажа равен 10, а при надевании экипировки с модификаторами на силу должен увеличиваться:</p>
<ol>
<li>создадим параметр strength (Сила) у предметов. Он будет храниться в базе данных, а отображаться со знаком "+" для положительных значений;</li>
<li>создадим параметр strength (Сила) у персонажей. Он будет вычисляемым при помощи выражения:<pre class="doc-code-sample">10 + char.equip.sum_strength</pre></li>
<li>в редакторе предметов зададим нужным предметам параметр "Сила". После этого предмет можно надевать, и сила персонажа увеличится.</li>
</ol>

<p>При надевании и снятии предметов характеристики персонажей могут измениться, и поэтому система производит проверку, все ли надетые предметы по-прежнему могут оставаться надетыми. И если окажется, что какие-то требования предмета не выполнены, то он свалится, что может повлечь изменения характеристик и сваливание ещё каких-нибудь предметов. При сваливании предмета игроку показывается системное сообщение, по какой причине это произошло.</p>

<h1>Квестовые события системы экипировки</h1>

<p>При надевании, снятии предметов, а также при их спадании с персонажа в случае невыполнения требований вызываются соответствующие квестовые события.</p>

<h2>Надевание предмета</h2>
<pre class="doc-code-sample">
equip wear {
  ...
}
</pre>
<p>Вызывается, когда персонаж надел предмет в слот. Обработчику доступны глобальные переменные item (предмет, который был надет) и slot (идентификатор слота).</p>

<h2>Снятие предмета</h2>
<pre class="doc-code-sample">
equip unwear {
  ...
}
</pre>
<p>Вызывается, когда персонаж снял предмет из слота. Обработчику доступны глобальные переменные item (предмет, который был надет) и slot (идентификатор слота).</p>

<h2>Спадание предмета</h2>
<pre class="doc-code-sample">
equip drop {
  ...
}
</pre>
<p>Вызывается, когда с персонажа свалился предмет экипировки в результате невыполнения требований. Обработчику доступны глобальные переменные item (предмет, который был надет) и slot (идентификатор слота).</p>

<h1>Оформление интерфейсов</h1>

<p>Вёрстка интерфейсов с разметкой экипировки задана в файлах <a href="/doc/game-template/character-page-avatar.html">character-page-avatar.html</a> и <a href="/doc/game-template/character-info-avatar.html">character-info-avatar.html</a>. Подробно параметры шаблонизатора описаны на странице <a href="/doc/design/character-info">Оформление страницы публичной информации персонажа</a> и <a href="/doc/design/character-page">Оформление внутриигровой страницы персонажа</a> соответственно.</p>

<p>Выбор предмета для надевания осуществляется через шаблон inventory.html, описанный на странице <a href="/doc/inventory#templates">Система инвентаря</a>.</p>

<p>При наведении мыши на надетый предмет всплывает подсказка, содержимое которой формируется при помощи шаблона <a href="/doc/game-template/item-hint.html">item-hint.html</a>. Он имеет следующие параметры шаблонизатора:<ul>
	<li>hint &mdash; текстовая подсказка в самом верху;</li>
	<li>image &mdash; URL изображения предмета (может отсутствовать);</li>
	<li>name &mdash; название предмета;</li>
	<li>quantity &mdash; количество предметов;</li>
	<li>params &mdash; список параметров предмета. Каждый элемент списка &mdash; структура:<ul>
		<li>header &mdash; заголовок (если присутствует, то это текст заголовка. Если отсутствует, то это обычный параметр с перечисленными ниже свойствами);</li>
		<li>name &mdash; название параметра;</li>
		<li>value &mdash; значение параметра;</li>
		<li>library_icon &mdash; HTML-код ссылки на описание параметра в библиотеке (может отсутствовать);</li>
	</ul></li>
	<li>description &mdash; описание предмета (может отсутствовать).</li>
</ul></p>

<h1>Дополнительно</h1>
<ul>
	<li><a href="/doc/script">Описание скриптового движка</a></li>
	<li><a href="/doc/quests">Описание квестового движка</a></li>
	<li><a href="/doc/parameters">Система параметров</a></li>
	<li><a href="/doc/design/gameinterface">Настройка оформления игры</a></li>
	<li><a href="/doc/inventory">Система инвентаря</a></li>
	<li><a href="/doc/design/character-info">Оформление страницы публичной информации персонажа</a></li>
	<li><a href="/doc/design/character-page">Оформление внутриигровой страницы персонажа</a></li>
	<li><a href="/doc/storage">Статическое хранилище</a></li>
</ul>
