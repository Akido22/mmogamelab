<!-- doc.title Настройка магазинов в конструкторе онлайн-игр -->
<!-- doc.parent index -->
<!-- doc.keywords магазин, товары, онлайн-игры -->
<!-- doc.description Как правильно настроить магазин игровых товаров в конструкторе игр MMO Constructor -->

<p>Магазин представляет собой игровой интерфейс для совершения двух видов сделок &mdash; продажи товаров персонажам и скупки товаров у персонажей. Магазины являются важной частью экономики онлайн-игры. Они отвечают за удобство игрока тратить игровые и реальные деньги. От правильной настройки магазинов зависит баланс притока и оттока денег в экономике.</p>

<p>Чтобы у вас появилась возможность создавать магазины, необходимо <a href="/doc/modules">подключить модуль</a> "Магазины".</p>

<h1>Создание магазинов</h1>

<p>Магазин является интерфейсом, который можно встроить в игру либо как <a href="/doc/locfunc">спецфункцию какой-либо локации</a>, либо как <a href="/doc/globfunc">глобальный интерфейс</a>. Вы можете иметь в игре любое количество магазинов. Ограничений на количество магазинов в одной локации также нет.</p>

<h2>Магазин в отдельной локации</h2>

<p>Рассмотрим, как создать магазин в виде отдельной локации. Для этого создадим новую локацию и укажем ей параметры: пропишем направление "Выход" и укажем тип изображения "Нет изображения": <img src="/st/tutorial/shop-1.png" alt="" class="doc-screenshot" /></p>
<p>Затем зайдём во вкладку "Спецфункции" и создадим новую функцию "Магазин". Установим галочки, позволяющие магазину как скупать, так и продавать товары: <img src="/st/tutorial/shop-2.png" alt="" class="doc-screenshot" /></p>
<p>Поскольку у этой локации нет отображения, то вкладку "Локация" у игрока надо скрыть. Заходим в настройки спецфункции "Локация" и устанавливаем признак "Доступность функции для персонажа" в "0": <img src="/st/tutorial/shop-3.png" alt="" class="doc-screenshot" /></p>
<p>Теперь на локации "Торговая площадь" создадим активную зону вокруг магазина и пропишем ей действие "Переход в локацию "Магазин": <img src="/st/tutorial/shop-4.png" alt="" class="doc-screenshot" /></p>

<h2>Магазин в той же локации</h2>

<p>Рассмотрим, как создать магазин, которым можно будет пользоваться, находясь прямо на Торговой площади, не переходя из неё в отдельную локацию. Для этого у локации "Торговая площадь" перейдём на вкладку "Спецфункции" и создадим магазин непосредственно в той же локации: <img src="/st/tutorial/shop-5.png" alt="" class="doc-screenshot" /></p>
<p>Вообще говоря, этого уже достаточно, чтобы магазин заработал &mdash; в локации появится новая вкладка, открывающая доступ к магазину. Однако, в целях удобства игрока, можно добавить активную зону вокруг магазина и прописать ей действие "Открыть спецфункцию локации "Магазин": <img src="/st/tutorial/shop-6.png" alt="" class="doc-screenshot" /></p>

<h2>Глобальный магазин</h2>

<p>Возможно, вы захотите сделать какой-либо магазин не привязанным к конкретной локации. Это может быть полезно для создания премиум-магазина, продающего товары за реальные деньги, таким, чтобы персонажу не приходилось куда-то идти. Потратить реальные деньги должно быть просто. Тогда вы можете создать <a href="/doc/globfunc">глобальный интерфейс</a> и прописать ему функцию магазина: <img src="/st/tutorial/shop-7.png" alt="" class="doc-screenshot" /></p>
<p>После создания такого магазина он немедленно становится доступным по URL "/globfunc/u_premium_shop".</p>

<h1>Настройка магазинов</h1>

<p>Привязывая функцию магазина к локации либо к глобальному интерфейсу, администратор устанавливает две галочки &mdash; "Магазин продаёт товары" и "Магазин скупает товары" (см. скриншоты выше). От них зависит, какие вкладки будут отображаться в интерфейсе магазина.</p>
<p>В полях "коррекция цены" администратор может задать выражение на <a href="/doc/script">скриптовом языке</a>, при помощи которого магазин будет рассчитывать цену товара. Более подробно этот вопрос будет рассмотрен в разделе <a href="#prices">Ценообразование</a>.</p>

<p>После того, как магазин создан, в списке спецфункций локации или в списке глобальных интерфейсов появится меню управления магазином. Список товаров, которые магазин продаёт или покупает, настраивается через кнопку "ассортимент магазина": <img src="/st/tutorial/shop-8.png" alt="" class="doc-screenshot" /></p>
<p>Напротив каждого товара администратор имеет возможность установить галочки "Магазин продаёт эти предметы" и "Магазин скупает эти предметы". Для каждого из товаров индивидуально задаются цены продажи и скупки, а также режим продажи и купли &mdash; со складом или без: <img src="/st/tutorial/shop-9.png?1" alt="" class="doc-screenshot" /></p>

<p>Если галочка "Помещать купленные товары на склад" не установлена, то товар, скупленный у персонажей, будет просто уничтожаться &mdash; магазин не будет хранить его. Если установлена, то товар будет складываться на собственный склад магазина. Аналогично работает галочка "Продавать только со склада". Если она снята, то магазин продаёт новый (не модифицированный) товар в неограниченном количестве, создавая его "из воздуха". Если галочка установлена, то магазин продаёт только тот товар, который есть у него на складе. Если товар на складе кончается, то продажа этого типа предметов приостановится до поступления на склад нового товара. Установка обеих галочек переводит магазин в режим замкнутого цикла. В этом режиме магазин не создаёт и не уничтожает товар, а просто выполняет функции посредника для упрощения товарообмена между персонажами.</p>

<p>В полях "Доступность для продажи" и "Доступность для покупки" задаются скриптовые условия, определяющие, может ли магазин продавать данный предмет данному персонажу (либо аналогично скупать). В выражениях можно использовать переменные char (персонаж) и item (предмет, для которого определяется доступность).</p>

<a name="prices"></a>
<h1>Ценообразование в магазинах</h1>

<p>В магазинах для каждого товара индивидуально настраиваются две цены &mdash; цена продажи товаров персонажам и цена скупки. Их настройки совершенно идентичны, далее описание будет только для цен продажи.</p>
<p>Администратор имеет возможность задать цену продажи вручную в любой валюте. Чтобы сделать это, необходимо в разделе "ассортимент магазина" заполнить поля "Цена продажи" и "Валюта продажи": <img src="/st/tutorial/shop-10.png" alt="" class="doc-screenshot" /></p>
<p>Если не заданы ни цена продажи, ни валюта продажи, то магазин обратится к <a href="/doc/inventory#editor">настройкам типа предмета</a> и возьмёт балансировочную цену предмета.</p>
<p>Особый случай позволяет автоматически конвертировать валюту балансировочной цены. Если цена продажи не задана, а валюта задана, и она отличается от валюты балансировочной цены, то магазин автоматически рассчитает цену продажи, сконвертировав балансировочную цену в указанную валюту. Курс конвертации настраивается через <a href="/doc/currency-rates">Настройку курсов валют</a>.</p>
<p>Если не заданы не цена продажи, ни балансировочная цена, то рассчитать цену продажи не представляется возможным, и товар не будет продаваться.</p>

<h2>Коррекция цен</h2>
<p>После того, как цена продажи получена, она подвергается коррекции при помощи скриптового выражения, которое задаётся в настройках магазина. В выражении доступны глобальные переменные:</p>
<ul>
	<li><strong>char</strong> &mdash; персонаж;</li>
	<li><strong>price</strong> &mdash; исходная цена;</li>
	<li><strong>currency</strong> &mdash; валюта;</li>
	<li><strong>item</strong> &mdash; предмет, на который вычисляется цена.</li>
</ul>
<p>Выражение должно вернуть новую цену. Цена будет автоматически округлена в большую сторону. Если вычисленная цена меньше минимального значения в данной валюте, то автоматически применяется минимальное значение. К примеру, если минимальное значение "0.01 руб", а выражение вернуло 0 или -100500, то цена продажи будет "0.01 руб".</p>
<p>Коррекцию полезно использовать для того, чтобы реализовывать механики скидок на товары. К примеру, за каждый уровень умения торговца (level_merchant) можно давать скидку 5%:</p>
<pre class="doc-code-sample">price * (1 - char.p_level_merchant * 0.05)</pre>
<p>По умолчанию, цена продажи не корректируется, а цена скупки установлена в 10% от номинальной.</p>

<h1>Просмотр склада магазина</h1>
<p>Администратор имеет возможность посмотреть список товаров, находящихся на складе магазина. Для этого необходимо выбрать пункт "склад магазина" из списка функций. Из того же интерфейса доступен просмотр истории операций со складом магазина. Обратите внимание, что если галочки "Товар продаётся только со склада" и "Купленный товар помещается на склад" не установлены, то операции не будут отображаться в списке операций со складом магазина.</p>

<h1>Разделы магазина</h1>

<p>Для магазинов введён отдельный <a href="/doc/inventory#categories">рубрикатор предметов</a>. С его помощью администратор может задать разделы, которые будут отображаться в пользовательском интерфейсе магазина. В административных интерфейсах будет использоваться рубрикатор "для административного интерфейса".

<h1>Оформление интерфейса магазина</h1>

<p>Все интерфейсы магазина форматируются при помощи шаблона <a href="/doc/game-template/shop-global.html">shop-global.html</a>. Информация о том, как изменять шаблоны, приведена в разделе <a href="/doc/design/gameinterface">Игровой интерфейс</a>. Доступны следующие параметры шаблонизатора:<ul>
	<li>title &mdash; заголовок на странице;</li>
	<li>shop_func_menu &mdash; меню функций магазина. Каждый элемент &mdash; это отдельный пункт, имеющий следующие атрибуты:<ul>
		<li>html &mdash; текст пункта меню;</li>
		<li>href &mdash; ссылка (может отсутствовать);</li>
	</ul></li>
	<li>content &mdash; содержание интерфейса.</li>
</ul></p>

<p>Ассортимент магазина отображается при помощи шаблона <a href="/doc/game-template/shop-items-layout.html">shop-items-layout.html</a>. Доступны следующие параметры шаблонизатора:<ul>
	<li>error &mdash; сообщение об ошибке (например, неудачной сделке; может отсутствовать);</li>
	<li>categories &mdash; список разделов магазина. Каждый элемент списка &mdash; структура:<ul>
		<li>id &mdash; идентификатор раздела;</li>
		<li>visible &mdash; признак изначально видимого раздела;</li>
		<li>items &mdash; список предметов в данной категории. Каждый элемент списка &mdash; структура:<ul>
			<li>dna &mdash; ДНК предмета;</li>
			<li>image &mdash; URL изображения предмета (может отсутствовать);</li>
			<li>name &mdash; название предмета;</li>
			<li>params &mdash; список параметров предмета. Каждый элемент списка &mdash; структура:<ul>
				<li>header &mdash; заголовок (если присутствует, то это текст заголовка. Если отсутствует, то это обычный параметр с перечисленными ниже свойствами);</li>
				<li>name &mdash; название параметра;</li>
				<li>value &mdash; значение параметра;</li>
				<li>library_icon &mdash; HTML-код ссылки на описание параметра в библиотеке (может отсутствовать);</li>
			</ul></li>
			<li>description &mdash; описание предмета (может отсутствовать);</li>
			<li>qparam &mdash; имя поля с указанием количества товара при передачи формы на сервер;</li>
			<li>min_quantity &mdash; минимально допустимое количество;</li>
			<li>max_quantity &mdash; максимально допустимое количество;</li>
			<li>show_max &mdash; признак, следует ли показывать кнопку для выбора максимального количества;</li>
		</ul></li>
	</ul></li>
	<li>Submit &mdash; текст кнопки отправки формы (обычно "Купить" или "Продать").</li>
</ul></p>

<p>Картинки предметов в магазине отображаются в том размере, который указан в <a href="/doc/inventory#images">настройках картинок</a> системы инвентаря под названием "Размеры в магазинах".</p>

<h1>Квестовые события</h1>

<p>При покупке товара вызывается квестовое событие shop-bought, которое может быть обработано в <a href="/doc/quests">квестовом движке</a> при помощи следующего обработчика:</p>
<pre class="doc-code-sample">
shop bought {
  ...
}
</pre>
<p>Аналогично при продаже товара в магазин вызывается событие shop-sold. Формат задания обработчика:</p>
<pre class="doc-code-sample">
shop sold {
  ...
}
</pre>

<h1>Дополнительно</h1>

<ul>
	<li><a href="/doc/inventory">Описание системы инвентаря</a></li>
	<li><a href="/doc/currency-rates">Задание курсов валют</a></li>
	<li><a href="/doc/locfunc">Спецфункции локаций</a></li>
	<li><a href="/doc/globfunc">Глобальные интерфейсы</a></li>
	<li><a href="/doc/script">Описание скриптового движка</a></li>
	<li><a href="/doc/quests">Описание квестового движка</a></li>
	<li><a href="/doc/design/gameinterface">Настройка оформления игры</a></li>
</ul>
