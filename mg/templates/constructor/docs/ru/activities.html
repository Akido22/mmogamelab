<!-- doc.title Система деятельности персонажей в конструкторе онлайн-игр -->
<!-- doc.parent index -->
<!-- doc.keywords деятельность, activity, онлайн-игры -->
<!-- doc.description Как настраивать произвольные действия, которые могут выполнять персонажи -->

<h1>Система деятельности персонажей</h1>

<p>Деятельность персонажа (activity) &mdash; это режим, в котором персонаж индивидуально выполняет какое-то действие в игре, при котором он считается занятым. Например, собирает растения, рубит деревья, ловит рыбу, варит эликсир и т.д.</p>

<p>Администратор игры имеет возможность настраивать произвольные условия начала деятельности, описывать её ход и результат. Во время того, как персонаж занят какой-либо деятельностью, администратор может настраивать обработчики произвольных событий, которые в это время происходят с персонажем (как в квестах).</p>

<a name="syntax"></a>
<h1>Синтаксис описания деятельности</h1>

<p>Деятельность начинается инструкцией квестого движка activity. Если быть точнее, то существуют варианты, как начать специальные виды деятельности без квестового движка. Например, <a href="/doc/crafting">крафт</a>. В этой статье рассматривается начало деятельности при помощи квестовой инструкции.</p>

<pre class="doc-code-sample">
activity {
  event "start" {
    message "Деятельность началась"
    activity timer timeout=30
  }
  timeout "done" {
    message "Деятельность закончилась. Выдаём результат"
    finish
  }
}</pre>

<p>Если выделить, например, на локации дерево, сделать его активной зоной, вызвать clicked, и в обработчике clicked запустить activity, по результатам которого будет выдано бревно, то получится деятельность "рубка деревьев":</p>

<pre class="doc-code-sample">
clicked "tree" {
  activity {
    ...
  }
}</pre>

<p>В фигурных скобках оператора activity задаются точно такие же обработчики, как в любом квесте. И ведут они себя точно так же, как и в квестах. Например, внутри activity можно сделать обработчик clicked, который будет каким-то образом менять поведение мирной деятельности.</p>

<h1>Понятие занятости персонажа</h1>

<p>Пока у персонажа запущена мирная деятельность, он считается занятым. Он не может перемещаться по локациям, переодеваться, торговать в магазинах и т.д. Проверить занятость персонажа можно при помощи свойства "busy" персонажа:</p>

<pre class="doc-code-sample">
if char.busy {
  ...
} else {
  ...
}
</pre>

<p>Если персонаж занят, это не обязательно означает, что он занят деятельностью, описанной в этой статье. Существуют и другие состояния, при которых персонаж считается занятым. Например, бой.</p>

<p>Если персонаж занимается именно какой-то деятельностью, то можно воспользоваться свойством "activity" персонажа, чтобы получить дополнительную информацию о деятельности. Значение char.activity &mdash; это либо объект CharActivity (если деятельность активна), или null, если нет.</p>

<a name="CharActivity"></a>
<h2>Объект CharActivity</h2>
<p>Этот объект предоставляет доступ к информации о текущей деятельности персонажа. Доступны следующие поля:</p>
<ul>
    <li>p_<strong>код</strong> &mdash; любые произвольные поля, установленные администратором игры.</li>
</ul>

<p>Содержимое текущего состояние занятости персонажа вместе с информацией обо всех внутренних полях объекта CharActivity можно посмотреть в информации о персонаже на вкладке "Квесты".</p>

<a name="timers"></a>
<h1>Таймеры деятельности</h1>

<p>Из скриптов внутри activity можно запускать специальный activity timer. Его синтаксис аналогичен синтаксису обычных таймеров за исключением того, что id не задаётся, зато можно задать text:</p>

<pre class="doc-code-sample">activity timer timeout=выражение [text="текст"] [indicator=выражение]</pre>

<p>Это специальный таймер, который при завершении вызывает событие "done" (обработчик есть в примере выше). Кроме того, этот таймер визуализируется в клиенте бегущей полоской, которая появляется посередине экрана. Когда таймер завершает свою работу, вызывается событие timeout "done", которое может быть обработано обработчиком деятельности.</p>

<p>Если задано поле text, то поверх прогресс-бара будет выведен указанный текст. Эту возможность полезно использовать для рекламы внутриигровых услуг, например: "Если вы хотите рубить деревья быстрее, выпейте Зелье Дровосека". А указанное зелье можно продавать за реальные деньги в магазине.</p>

<p>Если указано поле indicator, то в нём задаётся динамическое выражение, <a href="/doc/dynamic">изменяющееся со временем</a>, которое позволяет рассчитать положение индикатора прогресс-бара в любой момент времени (0 &mdash; крайнее левое положение, 1 &mdash; крайнее правое). Если indicator не задан, то полоска индикатора будет равномерно двигаться от 0 до 1. Используя произвольные выражения, можно сделать, чтобы полоска шла с какого-то промежуточного положения, или например наоборот &mdash; с конца в начало:</p>
<pre class="doc-code-sample">activity timer timeout=10 text="Идёт сбор травы" indicator=1 - (t - T) / 10</pre>

<p>Минимальным рекомендуемым временем работы таймера деятельности является 30 секунд. Если какая-то игра часто запускает таймеры деятельности на меньшее время, то приоритет событий будет автоматически снижаться системой так, чтобы эта игра не мешала работе других игр.</p>

<h1>Завершение деятельности</h1>

<p>При вызове finish или fail деятельность завершается (так же, как и в квестах), и персонаж освобождается. Отличие от квестов заключается в том, что успешно выполненная мирная деятельность не записывается в квестлог.</p>

<p>Если вы забыли сделать обработчик "done" или ещё каким-то образом привели персонажа в состояние занятости, из которого нет выхода, вы можете сбросить занятость через админку персонажа (вкладка "Квесты").</p>

<h1>Доступ к параметрам CharActivity</h1>

<p>Внутри обработчиков activity доступна глобальная переменная "activity" (тип CharActivity), которая представляет собой аналог контейнера "quest" в квестах. В activity можно сохранить любые параметры, которые администратор игры хочет сохранить между вызовами обработчиков. При завершении деятельности объект вместе со всеми данными уничтожается.</p>

<p>Как описано выше, у объектов персонажей появилось поле activity, которое либо равно null (если персонаж в данный момент не занят деятельностью), либо равно тому самому объекту CharActivity, если занят.</p>

<p>Между ключевым словом activity и фигурными скобками можно поместить список параметров, которые станут глобальными переменными при вызове обработчика start. Обработчик start — это самый первый обработчик, который вызывается автоматически при запуске деятельности. В нём можно сохранить какие-то из переданных переменных:</p>
<pre class="doc-code-sample">
activity p_param1=123 p_param2="abc" {
  event "start" {
    set activity.p_param1 = p_param1
    set activity.p_param2 = p_param2
    ...
  }
  ...
}</pre>

<a name="priorities"></a>
<h1>Приоритеты видов деятельности</h1>

<p>Персонаж может быть занят одновременно только одним видом деятельности. Бой также считается видом деятельности. Если персонаж хочет заняться следующим делом, сначала он должен прекратить заниматься предыдущим. Что делать, если персонаж собирает растения, а на него кто-то нападает? Сбор, скорее всего, должен прерваться, и должно быть произведено нападение. С другой стороны, если персонаж в бою, то если он хочет собирать растения, ему должно написаться, что он занят более приоритетным занятием.</p>

<p>Чтобы реализовать эту систему, введено понятие приоритета занятости. Это число, которое передаётся в параметре "priority":</p>

<pre class="doc-code-sample">
activity priority=50 {
  ...
}</pre>

<p>Если приоритет больше, чем приоритет текущего занятия, то текущее занятие будет прервано и запущено новое. Если меньше или равен, то будет написано, что "вы заняты", и ничего не выйдет. У боёв приоритет равен 100. Обратите внимание, то фактическое прерывание боя сейчас не реализовано. И если персонаж во время боя займётся чем-то с приоритетом больше 100, то могут произойти всякие непредвиденные ситуации. Скорее всего, персонаж займётся новой деятельности, но при этом останется в бою так, что игрок управлять им в бою не сможет. Лучше так не делать.</p>

<p>При прерывании действия у него вызывается событие "abort", в котором можно выполнить какие-то финализирующие действия:</p>

<pre class="doc-code-sample">
activity {
  event "abort" {
    ...
  }
}</pre>

<h1>Визуализация прогресс-бара</h1>

<p>Администратор имеет возможность настроить цвет прогресс-бара, изменяя CSS:</p>

<pre class="doc-code-sample">
#activity-progress-background { background-color: #404040 }
#activity-progress-indicator { background-color: #606060 }
#activity-progress-text { color: #ffffff }
</pre>

<p>Ширина прогресс-бара настраивается через хинты шаблона игрового интерфейса. В шаблоне blocks.html задаётся специальный div, содержимое которого используется как настройки размеров прогресс-бара:</p>

<pre class="doc-code-sample">
&lt;div class="x-hidden" id="progress-bar-hints"&gt;200,300&lt;/div&gt;
</pre>

<p>Первое число определяет ширину полей слева и справа от прогресс-бара (указывается сумма левого и правого поля в пикселах). Второе число задаёт высоту прогресс-бара (в пикселах).</p>

<h1>Пользовательская визуализация прогресс-бара</h1>

<p>Если администратор игры хочет изменить внешний вид прогресс-бара деятельности, то он может воспользоваться JavaScript API и реализовать собственную визуализацию. Для этого необходимо после загрузки скриптов интерфейса игры, но перед инициализацией игрового интерфейса (подробности см. на странице "<a href="/doc/design/gameinterface#javascript">Оформление игрового интерфейса</a>") установить свои обработчики:</p>

<pre class="doc-code-sample">
Game.activity_show = function (ratio, text) {
  ...
};
Game.activity_progress = function (ratio) {
  ...
};
Game.activity_hide = function () {
  ...
};
</pre>

<p>Метод activity_show вызывается, когда необходимо показать прогресс-бар (начальное положение индикатора &mdash; ratio, текст на прогресс-баре &mdash; text). Метод activity_progress вызывается, когда надо изменить положение индикатора, и activity_hide, &mdash; когда необходимо скрыть прогресс-бар.</p>

<p>Значение ratio &mdash; это число от 0 до 1, где 0 соответствует левому положению прогресс-бара, а 1 &mdash; правому.</p>

<h1>Дополнительно</h1>
<ul>
    <li><a href="/doc/script">Описание скриптового движка</a></li>
    <li><a href="/doc/quests">Описание квестового движка</a></li>
    <li><a href="/doc/crafting">Система крафта</a></li>
</ul>
