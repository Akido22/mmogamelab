<!-- doc.title Скриптовый движок конструктора игр -->
<!-- doc.parent index -->
<!-- doc.keywords скрипт, онлайн-игра, скриптовый -->
<!-- doc.description Описание языка скриптов конструктора онлайн-игр -->

<h1>Скриптовый движок конструктора игр</h1>

<p>Конструктор предоставляет администраторам игр возможности по гибкой настройке игровых правил при помощи скриптов. Скриптовый язык конструктора называется <strong>MMOScript</strong> и состоит из нескольких диалектов, применимых в определённых случаях:</p>

<ul>
    <li><strong>выражения MMOScript</strong> &mdash; это функции, получающие глобальные переменные в качестве аргументов, и возвращающие вычисленное значение. Пример:
    <pre class="doc-code-sample">(char.p_level &gt; 5) and char.location.p_dungeon</pre></li>
    Выражения MMOScript не могут ни при каких обстоятельствах модифицировать глобальные переменные. Они используются для проверки всяческих разрешений, можно ли данному персонажу сделать данное действие, для вычисления различных параметров и т.д. Подробно об устройстве выражений MMOScript написано в разделе "<a href="#expressions">Выражения MMOScript</a>" этого документа;
    <li><strong>текстовые строки с выражениями MMOScript</strong> &mdash; это строки, в которых при помощи специальных инструкций можно вставлять значения выражений. Пример:
    <pre class="doc-code-sample">{member.name} [member.sex:погиб,погибла]</pre></li>
    Подробно об устройстве текстовых выражений MMOScript написано в разделе "<a href="#text">Текстовые строки</a>" этого документа;
    <li><strong>MMOScript для квестов и триггеров</strong> &mdash; это императивный язык, на котором задаётся реакция системы на возникающие игровые события, такие как: вход персонажа в игру, переход в другую локацию, нажатие на кнопку в интерфейсе и т.д. Пример:
    <pre class="doc-code-sample">clicked "active_zone_1" {
    message "Вы вошли в подземелье и потеряли 50% жизни"
    set char.p_hp = char.p_hp / 2
}</pre>
    Программы на "квестовом MMOScript" могут изменять глобальные переменные и влиять на базу данных игры, изменяя тем самым параметры персонажей, локаций и объектов. Подробно этот язык описан в разделе "<a href="/doc/quests">Квесты и триггеры</a>";</li>
    <li><strong>Боевой MMOScript</strong> &mdash; это императивный язык, на котором задаётся реакция системы на возникающие события в бою, такие как: получение права хода участником боя, нанесение удара, смерть участника боя, завершение боя и т.д. Пример:
    <pre class="doc-code-sample">if member.active and member.p_hp &lt;= 0 {
    set member.active = 0
    log '{class="combat-log-member"}{member.name}{/class} {class="combat-log-dead"}[member.sex:погиб,погибла]{/class}' cls="dead"
    sound "//www.example.com/st/sounds/death.mp3" mode="wait"
}</pre>
    Программы на "боевом MMOScript" могут изменять глобальные переменные и влиять тем самым на текущее состояние боя, но не могут вмешиваться в базу данных игры. По окончании боя происходит событие "завершение боя", обработчик которого пишется на "Квестовом MMOScript" и позволяет сохранить в базе данных всё то, что случилось в бою (получен опыт, деньги, сломана экипировка и т.д.). Подробно этот язык описан в разделе "<a href="/doc/combats">Боевая система</a>".</li>
</ul>

<a name="expressions"></a>
<h1>Выражения MMOScript</h1>

<p>Скриптовый движок конструктора игр позволяет администраторам игр задавать на специальном языке вычисляемые выражения для своих игр.</p>

<h2>Синтаксис выражений</h2>

<h3>Типы значений</h3>
<ul class="doc-operators">
    <li><span class="doc-operator">123.45</span> &mdash; числа.
        <p>Поддерживаются как целые числа, так и числа с плавающей точкой;</p>
    </li>
    <li><span class="doc-operator">"Hello"</span> &mdash; произвольные unicode-строки.
        <p>Строки могут быть заключены в одинарные или двойные кавычки. Если строка начинается с двойной кавычки, то заканчиваться она должна также двойной. Если начинается с одинарной, то одинарной. Если вам необходимо поместить в строку саму кавычку, то поставьте перед ней обратный слэш: <strong>\"</strong>. Если необходимо поместить в строку сам обратный слэш, то напишите его два раза: <strong>\\</strong>. Примеры:</p>
        <pre class="doc-code-sample">"I'm a game designer"</pre>
        <pre class="doc-code-sample">'&lt;img src="/st/icon.gif" alt="" /&gt;'</pre>
        <pre class="doc-code-sample">"I said, \"I'm a game designer\""</pre>
    </li>
    <li><span class="doc-operator">vec3(1, 3, 10)</span> &mdash; трёхмерные векторы Vec3;</li>
    <li><span class="doc-operator">none</span> и <span class="doc-operator">nan</span> &mdash; специальные значения
        <p>Эти значения могут получиться в процессе вычисления (none &mdash; пустое значение, nan &mdash; not a number (не число).</p>
    </li>
</ul>

<p>При вычислении логических выражений значения none, 0 и пустая строка "" считаются ложными. Все остальные значения считаются истинными.</p>

<h3>Арифметические операции</h3>

<ul class="doc-operators">
    <li><span class="doc-operator">a + b</span> &mdash; сложение, конкатенация.
        <p>Выполняются следующие проверки в указанном порядке:</p>
        <ol>
        <li>если один из операндов равен none, то возвращается значение другого операнда;</li>
        <li>если оба операнда строковые, то выполняется конкатенация строк;</li>
        <li>если оба операнда &mdash; векторы одной размерности, то выполняется сложение векторов;</li>
        <li>если один из операндов вектор, а другой &mdash; не вектор или вектор другой размерности, то возвращается none;</li>
        <li>в оставшихся случаях операнды складываются как числа.</li>
    </ol></li>
    <li><span class="doc-operator">a - b</span> &mdash; вычитание.
        <p>Выполняются следующие проверки в указанном порядке:</p>
        <ol>
        <li>если второй операнд равен none, то возвращается значение первого операнда;</li>
        <li>если оба операнда &mdash; векторы одной размерности, то выполняется вычитание векторов;</li>
        <li>если первый операнд &mdash; none, а второй &mdash; вектор, то возвращается противоположный вектор;</li>
        <li>если один из операндов вектор, а другой &mdash; не вектор или вектор другой размерности, то возвращается none;</li>
        <li>в оставшихся случаях операнды вычитаются как числа.</li>
    </ol></li>
    <li><span class="doc-operator">-a</span> &mdash; унарный минус.
        <p>Выполняются следующие проверки в указанном порядке:</p>
        <ol>
        <li>если операнд равен none, возвращается none;</li>
        <li>если операнд &mdash; вектор, то возвращается противоположный вектор;</li>
        <li>в оставшихся случаях операнд приводится к числу, и возвращается противоположное ему значение.</li>
    </ol></li>
    <li><span class="doc-operator">a * b</span> &mdash; умножение.
        <p>Выполняются следующие проверки в указанном порядке:</p>
        <ol>
        <li>если первый операнд &mdash; вектор, то второй операнд приводится к числу и умножается на вектор;</li>
        <li>если второй операнд &mdash; вектор, то первый операнд приводится к числу и умножается на вектор;</li>
        <li>в оставшихся случаях операнды перемножаются как числа.</li>
    </ol></li>
    <li><span class="doc-operator">a / b</span> &mdash; деление.
        <p>Выполняются следующие проверки в указанном порядке:</p>
        <ol>
        <li>если второй аргумент, приведённый к числу, равен 0, то возвращается none;</li>
        <li>если первый аргумент &mdash; вектор, то второй операнд приводится к числу, и вектор делится на это число;</li>
        <li>в оставшихся случаях операнды приводятся к числам, и делятся как числа. Даже если аргументы целочисленные, деление будет выполняться с плавающей точкой.</li>
    </ol></li>
    <li><span class="doc-operator">a % b</span> &mdash; остаток от деления.
        <p>Выполняются следующие проверки в указанном порядке:</p>
        <ol>
        <li>если второй аргумент, приведённый к числу, равен 0, то возвращается none;</li>
        <li>в оставшихся случаях операнды приводятся к целым числам, и выполняется операция взятия остатка от деления.</li>
    </ol></li>
    <li><span class="doc-operator">abs(a)</span> &mdash; абсолютное значение.
        <p>Выполняются следующие действия в указанном порядке:</p>
        <ol>
        <li>аргумент приводится к числу;</li>
        <li>возвращается абсолютное значение числа.</li>
    </ol></li>
    <li><span class="doc-operator">sqrt(a)</span> &mdash; квадратный корень.
        <p>Выполняются следующие действия в указанном порядке:</p>
        <ol>
        <li>аргумент приводится к числу;</li>
        <li>если число отрицательное, возвращается nan;</li>
        <li>возвращается квадратный корень числа.</li>
    </ol></li>
    <li><span class="doc-operator">sqr(a)</span> &mdash; возведение в квадрат.
        <p>Выполняются следующие действия в указанном порядке:</p>
        <ol>
        <li>аргумент приводится к числу;</li>
        <li>возвращается квадрат числа.</li>
    </ol></li>
    <li><span class="doc-operator">log(a)</span> &mdash; натуральный логарифм.
        <p>Выполняются следующие действия в указанном порядке:</p>
        <ol>
        <li>аргумент приводится к числу;</li>
        <li>если число отрицательное, возвращается nan;</li>
        <li>возвращается натуральный логарифм числа.</li>
    </ol></li>
    <li><span class="doc-operator">exp(a)</span> &mdash; e<sup>a</sup>.
        <p>Выполняются следующие действия в указанном порядке:</p>
        <ol>
        <li>аргумент приводится к числу;</li>
        <li>возвращается e в степени этого числа.</li>
    </ol></li>
    <li><span class="doc-operator">pow(a, b)</span> &mdash; возведение в степень.
        <p>Выполняются следующие действия в указанном порядке:</p>
        <ol>
        <li>аргументы приводятся к числам;</li>
        <li>возвращается a в степени b. Если результат не определён (например, при возведении отрицательного числа в дробную степень), возвращается nan.</li>
    </ol></li>
</ul>

<h3>Операции сравнения</h3>
<ul class="doc-operators">
    <li><span class="doc-operator">a == b</span> &mdash; сравнение на равенство. Возвращается 1, если операнды равны, или 0, если не равны.
        <p>Выполняются следующие проверки в указанном порядке:</p>
        <ol>
        <li>векторы сравниваются покоординатно. Если векторы имеют разную размерность, или вектор сравнивается с не вектором, то возвращается 0;</li>
        <li>если один из операндов &mdash; строка, а другой &mdash; не строка, то строковый аргумент приводится к числу;</li>
        <li>операнды разных типов считаются разными, и возвращается 0;</li>
        <li>операнды сравниваются друг с другом по значению.</li>
    </ol></li>
    <li><span class="doc-operator">a != b</span> &mdash; сравнение на неравенство. Возвращается 0, если операнды равны, или 1, если не равны.
        <p>Выполняются следующие проверки в указанном порядке:</p>
        <ol>
        <li>векторы сравниваются покоординатно. Если векторы имеют разную размерность, или вектор сравнивается с не вектором, то возвращается 1;</li>
        <li>если один из операндов &mdash; строка, а другой &mdash; не строка, то строковый аргумент приводится к числу;</li>
        <li>операнды разных типов считаются разными, и возвращается 1;</li>
        <li>операнды сравниваются друг с другом по значению.</li>
    </ol></li>
    <li><span class="doc-operator">a &lt; b</span> &mdash; меньше.
        <p>Выполняются следующие проверки в указанном порядке:</p>
        <ol>
        <li>если оба операнда векторы, то выполняется покоординатное сравнение векторов. Сначала сравниваются первые координаты. Если они равны, то сравниваются вторые и т.д.;</li>
        <li>в оставшихся случаях операнды приводятся к числам и сравниваются как числа.</li>
    </ol></li>
    <li><span class="doc-operator">a &lt;= b</span> &mdash; меньше или равно.
        <p>Выполняются следующие проверки в указанном порядке:</p>
        <ol>
        <li>если оба операнда векторы, то выполняется покоординатное сравнение векторов. Сначала сравниваются первые координаты. Если они равны, то сравниваются вторые и т.д.;</li>
        <li>в оставшихся случаях операнды приводятся к числам и сравниваются как числа.</li>
    </ol></li>
    <li><span class="doc-operator">a &gt; b</span> &mdash; больше.
        <p>Выполняются следующие проверки в указанном порядке:</p>
        <ol>
        <li>если оба операнда векторы, то выполняется покоординатное сравнение векторов. Сначала сравниваются первые координаты. Если они равны, то сравниваются вторые и т.д.;</li>
        <li>в оставшихся случаях операнды приводятся к числам и сравниваются как числа.</li>
    </ol></li>
    <li><span class="doc-operator">a &gt;= b</span> &mdash; больше или равно.
        <p>Выполняются следующие проверки в указанном порядке:</p>
        <ol>
        <li>если оба операнда векторы, то выполняется покоординатное сравнение векторов. Сначала сравниваются первые координаты. Если они равны, то сравниваются вторые и т.д.;</li>
        <li>в оставшихся случаях операнды приводятся к числам и сравниваются как числа.</li>
    </ol></li>
    <li><span class="doc-operator">min(a, b, c, ...)</span> &mdash; минимум.
        <p>Выполняются следующие проверки в указанном порядке:</p>
        <ol>
        <li>если список пустой, возвращается none;</li>
        <li>все операнды преобразуются к числам;</li>
        <li>возвращается минимальное из них.</li>
    </ol></li>
    <li><span class="doc-operator">max(a, b, c, ...)</span> &mdash; максимум.
        <p>Выполняются следующие проверки в указанном порядке:</p>
        <ol>
        <li>если список пустой, возвращается none;</li>
        <li>все операнды преобразуются к числам;</li>
        <li>возвращается максимальное из них.</li>
    </ol></li>
</ul>

<h3>Логические операции</h3>
<ul class="doc-operators">
    <li><span class="doc-operator">not a</span> &mdash; логическое отрицание.
        <p>Выполняются следующие проверки в указанном порядке:</p>
        <ol>
        <li>если операнд равен 0, пустой строке или none, то возвращается 1;</li>
        <li>в остальных случаях возвращается 0.</li>
    </ol></li>
    <li><span class="doc-operator">a and b</span> &mdash; логическое "и".
        <p>Выполняются следующие проверки в указанном порядке:</p>
        <ol>
        <li>если первый операнд ложный, то возвращается его значение;</li>
        <li>в остальных случаях возвращается значение второго операнда.</li>
    </ol></li>
    <li><span class="doc-operator">a or b</span> &mdash; логическое "или".
        <p>Выполняются следующие проверки в указанном порядке:</p>
        <ol>
        <li>если первый операнд истинный, то возвращается его значение;</li>
        <li>в остальных случаях возвращается значение второго операнда.</li>
    </ol></li>
</ul>

<h3>Побитовые операции</h3>
<ul class="doc-operators">
    <li><span class="doc-operator">~a</span> &mdash; побитовое отрицание.
        <p>Выполняются следующие действия в указанном порядке:</p>
        <ol>
        <li>операнд приводится к целому числу;</li>
        <li>возвращается результат побитового отрицания. Число двоичных разрядов результата определяется реализацией интерпретатора.</li>
    </ol></li>
    <li><span class="doc-operator">a &amp; b</span> &mdash; побитовое "и".
        <p>Выполняются следующие действия в указанном порядке:</p>
        <ol>
        <li>операнды приводятся к целым числам;</li>
        <li>возвращается результат побитового "и".</li>
    </ol></li>
    <li><span class="doc-operator">a | b</span> &mdash; побитовое "или".
        <p>Выполняются следующие действия в указанном порядке:</p>
        <ol>
        <li>операнды приводятся к целым числам;</li>
        <li>возвращается результат побитового "или".</li>
    </ol></li>
</ul>

<h3>Строковые операции</h3>
<ul class="doc-operators">
    <li><span class="doc-operator">a in b</span> &mdash; поиск подстроки.
        <p>Выполняются следующие действия в указанном порядке:</p>
        <ol>
        <li>операнды приводятся к строкам;</li>
        <li>если подстрока a найдена в строке b, то возвращается 1. В противном случае &mdash; 0.</li>
    </ol></li>
    <li><span class="doc-operator">lc(a)</span> &mdash; нижний регистр.
        <p>Выполняются следующие действия в указанном порядке:</p>
        <ol>
        <li>операнд приводится к строке;</li>
        <li>возвращается строка в нижнем регистре.</li>
    </ol></li>
    <li><span class="doc-operator">uc(a)</span> &mdash; верхний регистр.
        <p>Выполняются следующие действия в указанном порядке:</p>
        <ol>
        <li>операнд приводится к строке;</li>
        <li>возвращается строка в верхнем регистре.</li>
    </ol></li>
</ul>

<h3>Управляющие операции</h3>
<ul class="doc-operators">
    <li><span class="doc-operator">a ? b : c</span> &mdash; условный оператор.
        <p>Выполняются следующие действия в указанном порядке:</p>
        <ol>
        <li>если операнд a истинный, то возвращается значение операнда b;</li>
        <li>иначе возвращается значение операнда c.</li>
    </ol></li>
</ul>

<h3>Случайные числа</h3>
<ul class="doc-operators">
    <li><span class="doc-operator">random</span> &mdash; случайное число:
        <p>Возвращается случайное число в диапазоне от 0 включительно до 1 не включительно.</p>
    </li>
    <li><span class="doc-operator">selrand(a, b, c, ...)</span> &mdash; случайный выбор из списка.
        <p>Выполняются следующие действия в указанном порядке:</p>
        <ol>
        <li>если список аргументов пустой, возвращается null;</li>
        <li>иначе возвращается значение одного случайно выбранного аргумента.</li>
    </ol></li>
</ul>

<h3>Округление</h3>
<ul class="doc-operators">
    <li><span class="doc-operator">floor(a)</span> &mdash; округление вниз.
        <p>Выполняются следующие действия в указанном порядке:</p>
        <ol>
        <li>аргумент приводится к числу;</li>
        <li>возвращается максимальное целое число, меньшее или равное аргументу.</li>
    </ol></li>
    <li><span class="doc-operator">ceil(a)</span> &mdash; округление вверх.
        <p>Выполняются следующие действия в указанном порядке:</p>
        <ol>
        <li>аргумент приводится к числу;</li>
        <li>возвращается минимальное целое число, большее или равное аргументу.</li>
    </ol></li>
    <li><span class="doc-operator">round(a)</span> &mdash; математическое округление.
        <p>Выполняются следующие действия в указанном порядке:</p>
        <ol>
        <li>аргумент приводится к числу;</li>
        <li>возвращается ближайшее к аргументу целое число.</li>
    </ol></li>
</ul>

<h3>Тригонометрия</h3>
<ul class="doc-operators">
    <li><span class="doc-operator">sin(a)</span> &mdash; синус.
        <p>Выполняются следующие действия в указанном порядке:</p>
        <ol>
        <li>аргумент приводится к числу;</li>
        <li>возвращается синус аргумента в радианах.</li>
    </ol></li>
    <li><span class="doc-operator">cos(a)</span> &mdash; косинус.
        <p>Выполняются следующие действия в указанном порядке:</p>
        <ol>
        <li>аргумент приводится к числу;</li>
        <li>возвращается косинус аргумента в радианах.</li>
    </ol></li>
    <li><span class="doc-operator">tan(a)</span> &mdash; тангенс.
        <p>Выполняются следующие действия в указанном порядке:</p>
        <ol>
        <li>аргумент приводится к числу;</li>
        <li>возвращается тангенс аргумента в радианах (или none, если значение тангенса не определено).</li>
    </ol></li>
    <li><span class="doc-operator">asin(a)</span> &mdash; арксинус.
        <p>Выполняются следующие действия в указанном порядке:</p>
        <ol>
        <li>аргумент приводится к числу;</li>
        <li>если значение аргумента не находится в пределах -1 .. 1, то возвращается none;</li>
        <li>возвращается арксинус числа. Результат возвращается в радианах.</li>
    </ol></li>
    <li><span class="doc-operator">acos(a)</span> &mdash; арккосинус.
        <p>Выполняются следующие действия в указанном порядке:</p>
        <ol>
        <li>аргумент приводится к числу;</li>
        <li>если значение аргумента не находится в пределах -1 .. 1, то возвращается none;</li>
        <li>возвращается арккосинус числа. Результат возвращается в радианах.</li>
    </ol></li>
</ul>

<h3>Доступ к объектам игры</h3>

<ul class="doc-operators">
    <li><span class="doc-operator">a.b</span> &mdash; доступ к полям объекта.
        <p>В зависимости от контекста, где используется выражение, доступны различные объекты. Как правило, во всех выражениях, касающихся конкретного персонажа, определён объект <strong>char</strong>, обозначающий персонажа. Используя оператор "точку" (<strong>.</strong>), вы можете получать доступ к полям этого объекта. Например, <strong>char.name</strong> &mdash; это имя персонажа, а <strong>char.sex</strong> &mdash; это его пол. Полный список доступных полей у каждого объекта приведён в следующих разделах.</p>
    </li>
</ul>

<a name="recursion"></a>
<h2>Превышение максимальной глубины рекурсии</h2>

<p>Если выражение приводит к неконтролируемой рекурсии (к примеру, если описать параметры персонажа param1=char.p_param2, а param2=char.p_param1), то вычислить его не представляется возможным. В этом случае результатом выражения будет none, а на e-mail администратору игры будет выслано письмо с описанием проблемы.</p>

<h2>Приоритет операций</h2>
<ol class="doc-operator-priorities">
        <li><span class="doc-operator">.</span></li>
        <li><span class="doc-operator">~</span></li>
        <li><span class="doc-operator">&amp;</span></li>
        <li><span class="doc-operator">|</span></li>
        <li><span class="doc-operator">*</span>, <span class="doc-operator">/</span> и <span class="doc-operator">%</span></li>
	<li><span class="doc-operator">+</span> и <span class="doc-operator">-</span></li>
        <li><span class="doc-operator">==</span>, <span class="doc-operator">!=</span>, <span class="doc-operator">&gt;</span>, <span class="doc-operator">&lt;</span>, <span class="doc-operator">&gt;=</span>, <span class="doc-operator">&lt;=</span> и <span class="doc-operator">in</span></li>
	<li><span class="doc-operator">not</span></li>
	<li><span class="doc-operator">and</span></li>
	<li><span class="doc-operator">or</span></li>
	<li><span class="doc-operator">?:</span></li>
</ol>

<a name="text"></a>
<h2>Формирование текстовых строк</h2>

<p>Зачастую разработчику игры необходимо сделать, чтобы какие-то текстовые строки менялись в зависимости от каких-либо условий. Например, когда персонаж входит в игру, полезно было бы иметь возможность настраивать текст в зависимости от его пола. Для модификации строк на лету предназначен язык формирования строк.</p>

<p>Чтобы сделать какую либо часть строки изменяемой, необходимо оформить её специальным образом. Синтаксис приведён ниже.</p>

<ul class="doc-operators">
    <li><span class="doc-operator">{...}</span> &mdash; вставка значения выражения.
        <p>Чтобы вставить в строку выражение, вычисляемое на языке, описанном в начале этого раздела, заверните его в фигурные скобки. Например:</p>
        <pre class="doc-code-sample">{char.name}</pre>
        <pre class="doc-code-sample">{loc.secret ? "секретная локация" : loc.name}</pre>
    </li>
    <li><span class="doc-operator">[index:str0,str1,str2,...]</span> &mdash; выбор значения по индексу.
        <p>Интерпретатор вычислит целое значение выражения индекса и возьмёт строку в зависимости от значения выражения_индекса. Если значение 0, то строку0, если 1, то строку1 и т.д. Пример:</p>
        <pre class="doc-code-sample">{char.name} [char.sex:ушёл,ушла] неизвестно куда</pre>
    </li>
    <li><span class="doc-operator">[#val:str1,str2,str5]</span> &mdash; выбор склонения числительного.
        <p>Зачастую в текстовых сообщениях необходимо просклонять числительное, выводимое в текстовых сообщениях. В зависимости от языка, правила склонения различаются. Конструктор использует язык, установленный для всей игры. Пример:</p>
        <pre class="doc-code-sample">Вы получили {local.p_xp} [#local.p_xp:единицу,единицы,единиц] опыта</pre>
    </li>
</ul>

<a name="conversions"></a>
<h1>Преобразования скриптовых выражений</h1>

<p>Приведённая ниже диаграмма описывает основные преобразования, которые производятся над выражениями MMOScript:</p>

<div><img src="/st/tutorial/MMOScript-conversions.png" alt="Преобразования MMOScript" /></div>

<p>Изначально выражение, введённое администратором, представлено в виде строки. Её разбором занимается парсер, на выходе которого получается синтаксическое дерево. Структура синтаксического дерева подробно рассмотрена в следующем разделе. Полученное синтаксическое дерево сохраняется в базе данных игры.</p>

<p>Каждый раз, когда администратор просматривает настройки игры, синтаксическое дерево загружается из базы данных и подвергается обратной процедуре &mdash; unparsing. На выходе анпарсера получается текстовое выражение, соответствующее синтаксическому дереву. Такой подход позволит в будущем реализовать в конструкторе альтернативные способы ввода выражений, например при помощи рисования блок-схем.</p>

<p>Во время работы игры синтаксические деревья выражений загружаются из базы данных и вычисляются &mdash; либо на сервере, либо в клиенте. Для того, чтобы вычислить значение выражения, интерпретатор подставляет в него значения глобальных переменных и выполняет вычисления в соответствии с деревом. Таким способом выражения вычисляются в подавляющем большинстве случаев.</p>

<h2>Частичное вычисление выражений</h2>

<p>Когда администратор игры задаёт значения <a href="/doc/dynamic">параметров, изменяемых со временем</a>, в выражениях участвует глобальная переменная "t", которую при вычислениях на стороне сервера подставлять не следует. В этом случае используется частичное вычисление значения. При этом в дерево подставляются значения всех параметров, кроме t, и все константные ветви дерева сворачиваются в соответствующие им значения. Все ветви, зависящие от t, остаются нетронутыми. Такое частичное синтаксическое дерево затем передаётся на клиент или сохраняется в базе данных, и в дальнейшем для определения моментального значения параметра производится ещё одно, на этот раз окончательное вычисление с подставленным значением t.</p>

<h1>Структура синтаксического дерева</h1>

<p>Выражение после парсинга представляется в форме синтаксического дерева, каждый узел которого &mdash; это либо константа, либо операция MMOScript. Для примера рассмотрим синтаксическое дерево, соответствующее выражению "30 + char.p_damage":</p>
<div><img src="/st/tutorial/MMOScript-syntaxtree-1.png" alt="Синтаксическое дерево" /></div>
<p>Самый верхний узел &mdash; это операция, выполняемая в последнюю очередь. В этом примере это сложение 30 и другого значения, которое составлено при помощи операции "." из глобальной переменной "char" и поля "p_damage". То есть, второй операнд у сложения &mdash; это "char.p_damage".</p>
<p>Более сложный пример &mdash; это выражение "(10 + source.p_damage) / (10 + target.p_defense)":</p>
<div><img src="/st/tutorial/MMOScript-syntaxtree-2.png" alt="Синтаксическое дерево" /></div>

<h2>Кодирование в JSON</h2>
<p>Для хранения синтаксических деревьев в базе данных и для передачи их в браузер используется формат JSON. Константы представляются своими значениями, а все остальные узлы дерева &mdash; списками, первый элемент которого &mdash; строковый код операции, а последующие элементы &mdash; её операнды.</p>
<p>Например, выражение "1 + 2" будет записано в JSON как:</p>
<pre class="doc-code-sample">["+", 1, 2]</pre>
<p>Если вместо константы будет другое составное выражение, то в JSON-формате вместо этой константы будет ещё один список. Рассмотрим пример "30 + char.p_damage" из предыдущего раздела:</p>
<pre class="doc-code-sample">[
    "+", 
    30, 
    [
        ".", 
        [ "glob", "char" ], 
        "p_damage"
    ]
]</pre>
<p>И второй пример "(10 + source.p_damage) / (10 + target.p_defense)":</p>
<pre class="doc-code-sample">[
    "/", 
    [
        "+", 
        10, 
        [
            ".", 
            [ "glob", "source" ],
            "p_damage"
        ]
    ], 
    [
        "+", 
        10, 
        [
            ".", 
            [ "glob", "target" ], 
            "p_defense"
        ]
    ]
]</pre>

<p>Вы можете воспользоваться <a href="/doc/expression-parser">онлайн-парсером выражений</a> и посмотреть код, соответствующий любой операции MMOScript.</p>

<h1>Описание типов объектов и их полей</h1>

<h2>Объект Character</h2>
<p>Объект типа Character представляет собой персонажа. Текущий персонаж, обычно, доступен через объект <strong>char</strong>. У этого объекта доступны следующие поля:</p>
<ul>
	<li>id &mdash; идентификатор персонажа;</li>
	<li>player &mdash; объект Player, обозначающий игрока, который этим персонажем играет (у одного игрока может быть несколько персонажей);</li>
	<li>money &mdash; объект Money, обозначающий деньги на аккаунте персонажа;</li>
	<li>location &mdash; объект Location, обозначающий текущую локацию персонажа;</li>
	<li>tech_online &mdash; признак "персонаж технически онлайн": 1 если он в игре, и 0, если вне игры;</li>
	<li>online &mdash; признак "персонаж онлайн": 1 если он в игре, и 0, если вне игры. Отличие этого поля от "tech_online" заключается в том, что, если вы в игре сделаете режим "невидимости", то, с точки зрения других игроков, он должен быть оффлайн. Поэтому, если персонаж в игре, но в невидимости, то online=0 и tech_online=1;</li>
	<li>name &mdash; имя персонажа;</li>
	<li>chatname &mdash; имя персонажа для вставки в чат (это будет строка вида "[ch:237457235723572354]", которую чат превратит в кликабельное имя персонажа);</li>
	<li>sex &mdash; пол персонажа (0 &mdash; мужской, 1 &mdash; женский);</li>
	<li>anyperm &mdash; признак, есть ли у персонажа доступ хотя бы к одной функции админки (1, если есть, 0, если нет);</li>
	<li>mod &mdash; объект Modifiers, описывающий действующие модификаторы персонажа;</li>
	<li>p_<strong>КОД</strong> &mdash; значение параметра с кодом "<strong>КОД</strong>". <a href="/doc/parameters">Подробнее о системе параметров</a>.</li>
	<li>html_<strong>КОД</strong> &mdash; HTML-представление параметра с кодом "<strong>КОД</strong>".</li>
	<li>perm_<strong>КОД</strong> &mdash; есть ли у персонажа привилегия "<strong>КОД</strong>". 1 &mdash; если да, 0 &mdash; если нет. Коды привилегий можно посмотреть в редакторе доступа персонажа;</li>
	<li>inv &mdash; объект Inventory, описывающий инвентарь персонажа;</li>
	<li>equip &mdash; объект CharacterEquip, описывающий экипировку персонажа;</li>
	<li>q_<strong>КОД</strong> &mdash; ход прохождения квеста с кодом "<strong>КОД</strong>". <a href="/doc/quests">Подробнее о квестах</a>.</li>
</ul>
<p>Если вам необходим доступ к другим полям, закажите его через <a href="/doc/reqauction">Аукцион заявок</a>.</p>

<h2>Объект Player</h2>
<p>Объект типа Player представляет собой игрока. Структурно у одного игрока может быть несколько персонажей, поэтому важно различать Character и Player. У объекта Player доступны следующие поля:</p>
<ul>
	<li>id &mdash; идентификатор игрока;</li>
	<li>mod &mdash; объект Modifiers, описывающий действующие модификаторы игрока. Модификаторами, в том числе, являются и подключенные <a href="/doc/paid-services">платные услуги</a>, к примеру, <strong>char.mod.fastmove</strong>.</li>
</ul>
<p>Если вам необходим доступ к другим полям, закажите его через <a href="/doc/reqauction">Аукцион заявок</a>.</p>

<h2>Объект Money</h2>
<ul>
	<li>balance_<strong>КОД</strong> &mdash; количество денег на балансе в валюте с указанным кодом. Например, если ваша валюта имеет код GLD, то поле будет называться balance_GLD;</li>
	<li>available_<strong>КОД</strong> &mdash; количество денег в валюте с указанным кодом, доступное для списания. Оно может отличаться от баланса, если нижний лимит счёта не равен нулю (например, если предоставлен кредитный лимит, то доступная сумма будет больше баланса), либо если на счету есть заблокированные средства (тогда доступная сумма будет меньше).</li>
</ul>
<p>Если вам необходим доступ к другим полям, закажите его через <a href="/doc/reqauction">Аукцион заявок</a>.</p>

<h2>Объект Location</h2>
<ul>
	<li>id &mdash; идентификатор локации;</li>
	<li>name &mdash; название локации;</li>
	<li>name_g &mdash; название локации в родительном падеже (genitive);</li>
	<li>name_a &mdash; название локации в винительном падеже (accusative);</li>
	<li>name_f &mdash; название локации "откуда" с предлогом (from);</li>
	<li>name_t &mdash; название локации "куда" с предлогом (to);</li>
	<li>name_w &mdash; название локации "где" с предлогом (where);</li>
	<li>p_<strong>КОД</strong> &mdash; значение параметра с кодом "<strong>КОД</strong>". <a href="/doc/parameters">Подробнее о системе параметров</a>;</li>
	<li>channel &mdash; идентификатор канала чата данной локации (можно использовать в команде "chat" <a href="/doc/quests/">квестового движка</a>).</li>
</ul>
<p>Если вам необходим доступ к другим полям, закажите его через <a href="/doc/reqauction">Аукцион заявок</a>.</p>

<h2>Объект Modifiers</h2>
<ul>
	<li><strong>код</strong> &mdash; признак, действует ли в данный момент модификатор с данным кодом (1, если действует, и 0, если нет);</li>
	<li>min_<strong>код</strong> &mdash; минимальное из значений действующих в данный момент модификаторов с данным кодом (0, если их вообще нет);</li>
	<li>max_<strong>код</strong> &mdash; максимальное из значений действующих в данный момент модификаторов с данным кодом (0, если их вообще нет);</li>
	<li>cnt_<strong>код</strong> &mdash; количество действующих в данный момент модификаторов с данным кодом;</li>
	<li>sum_<strong>код</strong> &mdash; сумма значений действующих в данный момент модификаторов с данным кодом.</li>
</ul>
<p>Если вам необходим доступ к другим полям, закажите его через <a href="/doc/reqauction">Аукцион заявок</a>.</p>

<h2>Объект Inventory</h2>
<ul>
	<li>max_<strong>параметр</strong> &mdash; максимальное значение параметра среди всех предметов, имеющихся в инвентаре;</li>
	<li>min_<strong>параметр</strong> &mdash; минимальное значение параметра;</li>
	<li>sum_<strong>параметр</strong> &mdash; суммарное значение параметра у всех предметов, имеющихся в инвентаре;</li>
	<li>cnt_<strong>тип</strong> &mdash; количество предметов типа "<strong>тип</strong>", имеющихся в инвентаре (независимо от того, имеют они модификации или нет);</li>
	<li>cnt_dna_<strong>ДНК</strong> &mdash; количество предметов с ДНК, в точности равным "<strong>ДНК</strong>", имеющихся в инвентаре.</li>
</ul>
<p>Если вам необходим доступ к другим полям, закажите его через <a href="/doc/reqauction">Аукцион заявок</a>.</p>

<h2>Объект Quest</h2>
<p>Этот объект предоставляет доступ к ходу прохождения квеста персонажем. Его поля описаны на странице "<a href="/doc/quests#object">Квестовый движок</a>".</p>

<h2>Объект Item</h2>
<p>Этот объект предоставляет доступ к предмету. Его поля описаны на странице "<a href="/doc/inventory#object">Система инвентаря</a>".</p>

<h2>Объект CharacterEquip</h2>
<p>Этот объект предоставляет доступ к экипировке персонажа. Его поля описаны на странице "<a href="/doc/equip#object">Система экипировки персонажей</a>".</p>

<a name="local"></a>
<h2>Объект ScriptMemoryObject</h2>
<p>Этот объект доступен в <a href="/doc/quests">квестовом</a> и <a href="/doc/combats">боевом</a> движках под именем "local". Он позволяет сохранять временные значения на время жизни обработчика события. После вызова всех обработчиков для данного события объект ScriptMemoryObject уничтожается.</p>

<h2>Объект Combat</h2>
<p>Этот объект предоставляет доступ к текущему бою. Его поля описаны на странице "<a href="/doc/combats#object">Боевая система</a>".</p>

<h2>Объект CombatMember</h2>
<p>Этот объект предоставляет доступ к участнику текущего боя. Его поля описаны на странице "<a href="/doc/combats#object">Боевая система</a>".</p>

<h2>Объект CombatAction</h2>
<p>Этот объект предоставляет доступ к действию в текущем бою. Его поля описаны на странице "<a href="/doc/combats#object">Боевая система</a>".</p>
