<!-- doc.title Скриптовый движок конструктора игр -->
<!-- doc.parent index -->
<!-- doc.keywords скрипт, онлайн-игра, скриптовый -->
<!-- doc.description Описание языка скриптов конструктора онлайн-игр -->

<p>Скриптовый движок конструктора игр позволяет администраторам игр задавать на специальном языке вычисляемые выражения для своих игр.</p>

<h2>Синтаксис выражений</h2>

<ul>
	<li>Арифметические операции: <strong>+</strong>, <strong>-</strong>, <strong>*</strong>, <strong>/</strong>. Для чисел они имеют очевидный математический смысл. Если в качестве операндов попадутся не числа, а строки, то они будут конвертированы в числа. Т.е. <strong>"3" - "2"</strong> выдаст результат <strong>1</strong>. Если преобразование строки в число не удалось, то операнд считается равным 0. Единственное исключение &mdash; операция <strong>+</strong>: если оба операнда строковые, то вместо сложения будет выполнена операция конкатенации строк: <strong>"abc" + "def"</strong> даст <strong>"abcdef"</strong>. Операция деления всегда возвращает число с плавающей точкой (даже если операнды целые), т.е. <strong>1 / 2</strong> даст <strong>0.5</strong>.</li>
        <li>Операции сравнения: <strong>&gt;</strong>, <strong>&lt;</strong>, <strong>&gt;=</strong>, <strong>&lt;=</strong>, <strong>==</strong>, <strong>!=</strong>. Эти операции производят сравнение двух операндов и возвращают 1, если условие истинно, и 0, если ложно. Все операции сравнения производятся над числами. Если вместо числа в качестве операнда будет передана строка, то она будет преобразована в число, и будут сравниваться уже числа. Если преобразование строки в число не удалось, то операнд считается равным 0. Единственное исключение &mdash; если в операцях <strong>==</strong> или <strong>!=</strong> сравниваются две строки. В этом случае они не преобразуются числа и сравниваются просто на точное совпадение.</li>
	<li>Логические операции: <strong>and</strong>, <strong>or</strong>, <strong>not</strong>. Эти операции, оценивая значения своих операндов на истинность, пользуются следующими соглашениями: если операнд &mdash; число, то истинным считается любое ненулевое значение, а ложью нулевое. Если операнд &mdash; строка, то пустая строка считается ложью, а любая непустая &mdash; истиной. Пустое значение <strong>none</strong> считается ложным, а любой объект (Character, Player и т.д.) истинным. Операция <strong>and</strong> &mdash; это логическое "И". Если первый операнд ложный, то результатом операции будет значение первого операнда, иначе значение второго операнда. Операция <strong>or</strong> &mdash; это логическое "ИЛИ". Если первый операнд истинный, то результатом операции будет значение первого операнда, иначе значение второго операнда. Операция <strong>not</strong> возвращает 0, если её единственный операнд истинный или 1, если ложный. Примеры:<ul>
		<li>(char.level <strong>&gt;=</strong> 5) <strong>and</strong> (char.sex <strong>==</strong> 1)</li>
		<li>(char.level <strong>&lt;</strong> 5) <strong>or</strong> (char.sex <strong>==</strong> 0)</li>
		<li><strong>not</strong> char.mod.some_modifier</li>
            </ul></li>
            <li>Побитовые логические операции: <strong>&</strong> (и), <strong>|</strong> (или), <strong>~</strong> (не). Аргументы этих операций предварительно преобразуются к целому числу. Если преобразование в число не удалось, берётся значение 0.</li>
	<li>Условный тройной оператор: <strong>?:</strong>. Этот оператор имеет три операнда &mdash; условие и два значения. Если условие истинно, то возвращается первое значение. Если ложно, то второе. Оператор записывается в следующей форме: "условие <strong>?</strong> выражение1 <strong>:</strong> выражение2". Пример:<ul>
		<li>(char.level <strong>&gt;=</strong> 3) ? 5 : 3</li>
	</ul></li>
	<li>Функции <strong>min</strong> и <strong>max</strong>. Возвращают минимальный и максимальный из своих аргументов соответственно. Если какой-то из аргументов не удалось преобразовать в число, он принимается равным 0. Пример:<ul>
		<li><strong>min</strong>(char.level, 3, char.magic_level)</li>
            </ul></li>
        <li>Функция <strong>selrand</strong> возвращает случайный элемент из переданного списка. Пример:<ul>
            <li><strong>selrand</strong>('head', 'chest', 'waist', 'legs')</li>
        </ul></li>
	<li>Доступ к объектам игры. В зависимости от контекста (где используется ваше выражение), вам будут доступны различные объекты. Как правило, во всех выражениях, касающихся конкретного персонажа, определён объект <strong>char</strong>, обозначающий персонажа. Используя оператор "точку" (<strong>.</strong>), вы можете получать доступ к полям этого объекта. Например, <strong>char.name</strong> &mdash; это имя персонажа, а <strong>char.sex</strong> &mdash; это его пол. Полный список доступных полей у каждого объекта приведён ниже.</li>
	<li>Строки. Строки могут быть заключены в одинарные или двойные кавычки. Если строка начинается с двойной кавычки, то заканчиваться она должна также двойной. Если начинается с одинарной, то одинарной. Если вам необходимо поместить в строку саму кавычку, то поставьте перед ней обратный слэш: <strong>\"</strong>. Если необходимо поместить в строку сам обратный слэш, то напишите его два раза: <strong>\\</strong>.</li>
	<li>random &mdash; случайное число в диапазоне от 0 (включительно) до 1 (не включительно).</li>
	<li>Строковые операции:<ul>
		<li><strong>uc</strong>(выражение) &mdash; перевести строковое выражение в верхний регистр;</li>
		<li><strong>lc</strong>(выражение) &mdash; перевести строковое выражение в нижний регистр;</li>
		<li>"подстрока" <strong>in</strong> "строка" &mdash; проверка, является ли "подстрока" подстрокой "строки". На месте подстроки и строки могут быть любые выражения. Если строка содержит подстроку, то это выражение будет равно 1, если не содержит, то 0.</li>
	</ul></li>
</ul>

<a name="recursion"></a>
<h2>Превышение максимальной глубины рекурсии</h2>

<p>Если выражение приводит к неконтролируемой рекурсии (к примеру, если описать параметры персонажа param1=char.p_param2, а param2=char.p_param1), то вычислить его не представляется возможным. В этом случае результатом выражения будет null, а на e-mail администратору игры будет выслано письмо с описанием проблемы.</p>

<h2>Приоритет операций</h2>
<ol>
	<li><strong>*</strong> и <strong>/</strong>;</li>
	<li><strong>+</strong> и <strong>-</strong>;</li>
        <li><strong>==</strong>, <strong>!=</strong>, <strong>&gt;</strong>, <strong>&lt;</strong>, <strong>&gt;=</strong>, <strong>&lt;=</strong> и <strong>in</strong>;</li>
	<li><strong>not</strong></li>
	<li><strong>and</strong></li>
	<li><strong>or</strong></li>
	<li><strong>?:</strong></li>
</ol>

<a name="text"></a>
<h2>Формирование строк</h2>

<p>Зачастую разработчику игры необходимо сделать, чтобы какие-то текстовые строки менялись, в зависимости от каких-то условий. Например, когда персонаж входит в игру, полезно было бы иметь возможность настраивать текст, в зависимости от его пола. Для модификации строк на лету предназначен язык формирования строк.</p>

<p>Чтобы сделать какую либо часть строки изменяемой, необходимо оформить её специальным образом. Синтаксис приведён ниже.</p>

<ul>
	<li>Вставка значения выражения. Чтобы вставить в строку выражение, вычисляемое на языке, описанном в начале этого раздела, заверните его в фигурные скобки. Например:<ul>
		<li><strong>{</strong>char.name<strong>}</strong></li>
		<li><strong>{</strong>loc.secret ? "секретная локация" : loc.name<strong>}</strong></li>
	</ul></li>
	<li>Выбор значения по индексу. Самое частое применение этой возможности &mdash; изменение сообщений, в зависимости от пола персонажа. Формат записи: <strong>[</strong>выражение_индекса<strong>:</strong>строка0<strong>,</strong>строка1<strong>,</strong>...<strong>]</strong>. Интерпретатор вычислит целое значение выражения_индекса и возьмёт строку, в зависимости от значения выражения_индекса. Если значение 0, то строку0, если 1, то строку1 и т.д. Пример:<ul>
		<li><strong>{</strong>char.name<strong>}</strong> <strong>[</strong>char.sex<strong>:</strong>ушёл<strong>,</strong>ушла<strong>]</strong> неизвестно куда</li>
        </li></ul>
        <li>Выбор склонения числительного. Зачастую в текстовых сообщениях необходимо просклонять числительное, выводимое в текстовых сообщениях. В зависимости от языка, правила склонения различаются. Конструктор использует язык, установленный для всей игры. Формат записи: <strong>[#</strong>числовое_выражение<strong>:</strong>строка1<strong>,</strong>строка2<strong>,</strong>строка5<strong>]</strong>. Пример:<ul>
            <li>Вы получили <strong>{</strong>local.p_xp<strong>}</strong> <strong>[#</strong>local.p_xp<strong>:</strong>единицу<strong>,</strong>единицы<strong>,</strong>единиц</strong><strong>]</strong> опыта</li>
        </li></ul>
</ul>

<h2>Объект Character</h2>
<p>Объект типа Character представляет собой персонажа. Текущий персонаж, обычно, доступен через объект <strong>char</strong>. У этого объекта доступны следующие поля:</p>
<ul>
	<li>id &mdash; идентификатор персонажа;</li>
	<li>player &mdash; объект Player, обозначающий игрока, который этим персонажем играет (у одного игрока может быть несколько персонажей);</li>
	<li>money &mdash; объект Money, обозначающий деньги на аккаунте персонажа;</li>
	<li>location &mdash; объект Location, обозначающий текущую локацию персонажа;</li>
	<li>tech_online &mdash; признак "персонаж технически онлайн": 1 если он в игре, и 0, если вне игры;</li>
	<li>online &mdash; признак "персонаж онлайн": 1 если он в игре, и 0, если вне игры. Отличие этого поля от "tech_online" заключается в том, что, если вы в игре сделаете режим "невидимости", то, с точки зрения других игроков, он должен быть оффлайн. Поэтому, если персонаж в игре, но в невидимости, то online=0 и tech_online=1;</li>
	<li>name &mdash; имя персонажа;</li>
	<li>chatname &mdash; имя персонажа для вставки в чат (это будет строка вида "[ch:237457235723572354]", которую чат превратит в кликабельное имя персонажа);</li>
	<li>sex &mdash; пол персонажа (0 &mdash; мужской, 1 &mdash; женский);</li>
	<li>anyperm &mdash; признак, есть ли у персонажа доступ хотя бы к одной функции админки (1, если есть, 0, если нет);</li>
	<li>mod &mdash; объект Modifiers, описывающий действующие модификаторы персонажа;</li>
	<li>p_<strong>КОД</strong> &mdash; значение параметра с кодом "<strong>КОД</strong>". <a href="/doc/parameters">Подробнее о системе параметров</a>.</li>
	<li>html_<strong>КОД</strong> &mdash; HTML-представление параметра с кодом "<strong>КОД</strong>".</li>
	<li>perm_<strong>КОД</strong> &mdash; есть ли у персонажа привилегия "<strong>КОД</strong>". 1 &mdash; если да, 0 &mdash; если нет. Коды привилегий можно посмотреть в редакторе доступа персонажа;</li>
	<li>inv &mdash; объект Inventory, описывающий инвентарь персонажа;</li>
	<li>equip &mdash; объект CharacterEquip, описывающий экипировку персонажа;</li>
	<li>q_<strong>КОД</strong> &mdash; ход прохождения квеста с кодом "<strong>КОД</strong>". <a href="/doc/quests">Подробнее о квестах</a>.</li>
</ul>
<p>Если вам необходим доступ к другим полям, закажите его через <a href="/doc/reqauction">Аукцион заявок</a>.</p>

<h2>Объект Player</h2>
<p>Объект типа Player представляет собой игрока. Структурно у одного игрока может быть несколько персонажей, поэтому важно различать Character и Player. У объекта Player доступны следующие поля:</p>
<ul>
	<li>id &mdash; идентификатор игрока;</li>
	<li>mod &mdash; объект Modifiers, описывающий действующие модификаторы игрока. Модификаторами, в том числе, являются и подключенные <a href="/doc/paid-services">платные услуги</a>, к примеру, <strong>char.mod.fastmove</strong>.</li>
</ul>
<p>Если вам необходим доступ к другим полям, закажите его через <a href="/doc/reqauction">Аукцион заявок</a>.</p>

<h2>Объект Money</h2>
<ul>
	<li>balance_<strong>КОД</strong> &mdash; количество денег на балансе в валюте с указанным кодом. Например, если ваша валюта имеет код GLD, то поле будет называться balance_GLD;</li>
	<li>available_<strong>КОД</strong> &mdash; количество денег в валюте с указанным кодом, доступное для списания. Оно может отличаться от баланса, если нижний лимит счёта не равен нулю (например, если предоставлен кредитный лимит, то доступная сумма будет больше баланса), либо если на счету есть заблокированные средства (тогда доступная сумма будет меньше).</li>
</ul>
<p>Если вам необходим доступ к другим полям, закажите его через <a href="/doc/reqauction">Аукцион заявок</a>.</p>

<h2>Объект Location</h2>
<ul>
	<li>id &mdash; идентификатор локации;</li>
	<li>name &mdash; название локации;</li>
	<li>name_g &mdash; название локации в родительном падеже (genitive);</li>
	<li>name_a &mdash; название локации в винительном падеже (accusative);</li>
	<li>name_f &mdash; название локации "откуда" с предлогом (from);</li>
	<li>name_t &mdash; название локации "куда" с предлогом (to);</li>
	<li>name_w &mdash; название локации "где" с предлогом (where);</li>
	<li>p_<strong>КОД</strong> &mdash; значение параметра с кодом "<strong>КОД</strong>". <a href="/doc/parameters">Подробнее о системе параметров</a>;</li>
	<li>channel &mdash; идентификатор канала чата данной локации (можно использовать в команде "chat" <a href="/doc/quests/">квестового движка</a>).</li>
</ul>
<p>Если вам необходим доступ к другим полям, закажите его через <a href="/doc/reqauction">Аукцион заявок</a>.</p>

<h2>Объект Modifiers</h2>
<ul>
	<li><strong>код</strong> &mdash; признак, действует ли в данный момент модификатор с данным кодом (1, если действует, и 0, если нет);</li>
	<li>min_<strong>код</strong> &mdash; минимальное из значений действующих в данный момент модификаторов с данным кодом (0, если их вообще нет);</li>
	<li>max_<strong>код</strong> &mdash; максимальное из значений действующих в данный момент модификаторов с данным кодом (0, если их вообще нет);</li>
	<li>cnt_<strong>код</strong> &mdash; количество действующих в данный момент модификаторов с данным кодом;</li>
	<li>sum_<strong>код</strong> &mdash; сумма значений действующих в данный момент модификаторов с данным кодом.</li>
</ul>
<p>Если вам необходим доступ к другим полям, закажите его через <a href="/doc/reqauction">Аукцион заявок</a>.</p>

<h2>Объект Inventory</h2>
<ul>
	<li>max_<strong>параметр</strong> &mdash; максимальное значение параметра среди всех предметов, имеющихся в инвентаре;</li>
	<li>min_<strong>параметр</strong> &mdash; минимальное значение параметра;</li>
	<li>sum_<strong>параметр</strong> &mdash; суммарное значение параметра у всех предметов, имеющихся в инвентаре;</li>
	<li>cnt_<strong>тип</strong> &mdash; количество предметов типа "<strong>тип</strong>", имеющихся в инвентаре (независимо от того, имеют они модификации или нет);</li>
	<li>cnt_dna_<strong>ДНК</strong> &mdash; количество предметов с ДНК, в точности равным "<strong>ДНК</strong>", имеющихся в инвентаре.</li>
</ul>
<p>Если вам необходим доступ к другим полям, закажите его через <a href="/doc/reqauction">Аукцион заявок</a>.</p>

<h2>Объект Quest</h2>
<p>Этот объект предоставляет доступ к ходу прохождения квеста персонажем. Его поля описаны на странице "<a href="/doc/quests#object">Квестовый движок</a>".</p>

<h2>Объект Item</h2>
<p>Этот объект предоставляет доступ к предмету. Его поля описаны на странице "<a href="/doc/inventory#object">Система инвентаря</a>".</p>

<h2>Объект CharacterEquip</h2>
<p>Этот объект предоставляет доступ к экипировке персонажа. Его поля описаны на странице "<a href="/doc/equip#object">Система экипировки персонажей</a>".</p>

<h2>Объект ScriptMemoryObject</h2>
<p>Этот объект доступен в <a href="/doc/quests">квестовом</a> и <a href="/doc/combats">боевом</a> движках под именем "local". Он позволяет сохранять временные значения на время жизни обработчика события. После вызова всех обработчиков для данного события объект ScriptMemoryObject уничтожается.</p>
