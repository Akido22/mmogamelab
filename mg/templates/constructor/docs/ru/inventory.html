<!-- doc.title Система инвентаря в конструкторе игр -->
<!-- doc.parent index -->
<!-- doc.keywords предметы, редактор предметов, инвентарь, онлайн-игры -->
<!-- doc.description Описание работы системы инвентаря в конструкторе онлайн-игр -->

<h1>Система инвентаря</h1>

<p>Система инвентаря позволяет администраторам онлайн-игр создавать в своих играх предметы, прописывать им характеристики, выдавать и изымать предметы у персонажей и предоставлять аналогичный функционал другим системам игры.</p>

<p>Чтобы в игре появилась система предметов, вам необходимо подключить <a href="/doc/modules">модуль</a> "Система инвентаря". После этого в административном интерфейсе появится меню "Инвентарь", через который настраивается основная часть системы.</p>

<h1>Параметры предметов</h1>

<p>Предметы могут иметь различные характеристики. Набор параметров, которые вы можете приписать предмету, вы задаёте самостоятельно через <a href="/doc/parameters">систему параметров</a>. Для этого зайдите в раздел "Инвентарь / Параметры предметов" и создайте необходимые вам параметры.</p>

<a name="instances"></a>
<h1>Тип предметов и экземпляр предмета</h1>

<p>Тип предмета — это объект, хранящий информацию об общих свойствах для всех предметов данного типа. К примеру "Молот Страшной Мести" — это тип предмета, описывающий название молота, его картинку, боевые характеристики и т.д. Экземпляр предмета — это конкретный предмет, лежащий в инвентаре персонажа. Если предмет имеет тип "Молот Страшной Мести", то его свойства будут в точности соответствовать свойствам, описанным в характеристиках типа. Однако, у конкретных экземпляров можно переопределить любой параметр таким образом, что все параметры, которые не переопределены, будут браться из параметров типа, а те, которые переопределены, будут браться из параметров экземпляра.</p>

<p>Пример: тип предмета "Большой Топор" имеет характеристики:</p>
<pre class="doc-code-sample">урон=10
проникающее_ранение=5</pre>
<p>В каком-то квесте персонаж может получить модифицированную версию топора с модифицированными характеристиками:</p>
<pre class="doc-code-sample">урон=15
отравление=5</pre>
<p>В итоге, характеристики предмета будут:</p>
<pre class="doc-code-sample">урон=15
проникающее_ранение=5
отравление=5</pre>
<p>Если после этого администратор изменит свойства типа предмета на:</p>
<pre class="doc-code-sample">урон=11
проникающее_ранение=4</pre>
<p>то характеристики предмета станут:</p>
<pre class="doc-code-sample">урон=15
проникающее_ранение=4
отравление=5</pre>
<p>Видно, что модифицированная характеристика осталась прежней, а немодифицированная автоматически изменилась.</p>

<a name="dna"></a>
<p>Чтобы отличать оригинальные предметы от модифицированных, каждому варианту предметов и их модификаций сопоставляется уникальные идентификаторы &mdash; ДНК предметов. ДНК предмета — уникальная строка, описывающая свойства экземпляра предмета. Если у предмета нет переопределённых параметров (т.е. это обычный предмет, без модификаций), то его ДНК в точности совпадает с ID типа предмета. Если у предмета переопределены какие-то параметры, то ДНК будет состоять из двух частей &mdash; ID типа предмета и хэша MD5 от модифицированных параметров. Все предметы с одинаковым ДНК могут складываться в стопку, т.е. в одну ячейку инвентаря. Обратите внимание, что есть ограничения на количество разных типов предметов, которые могут одновременно находиться в инвентаре. Так, 3 одинаковых "Больших Топора" будут занимать одну ячейку, а 3 разных "Больших Топора" (с характеристиками, модифицированными по-разному) &mdash; 3 ячейки. Про ограничения написано ниже, в разделе <a href="#constraints">Ограничения грузоподъёмности персонажа</a>.</p>

<a name="editor"></a>
<h1>Редактор типов предметов</h1>

<p>Через меню "Инвентарь / Типы предметов" вы можете создавать новые предметы и вводить их в игру. У каждого предмета есть набор основных параметров: <img class="doc-screenshot" src="/st/tutorial/inventory-8.png?1" alt="" /></p>
<ul>
	<li>Название предмета</li>
	<li>Порядок сортировки &mdash; предметы будут сортироваться в порядке возрастания этого числа.</li>
	<li>"Предмет можно выбросить" &mdash; <a href="/doc/script">скриптовое выражение</a>, позволяющее определить, имеет ли данный персонаж право выбросить данный предмет. Вы можете запретить выбрасывать предмет, прописав сюда 0. Или разрешить, прописав 1. Также можно любое другое выражение. Например, разрешить выбрасывать предмет только новичкам до 5 уровня включительно:<pre class="doc-code-sample">char.p_level &lt;= 5</pre>Или запретить выбрасывать акваланг, находясь под водой:<pre class="doc-code-sample">not char.location.p_underwater</pre></li>
	<li>Балансировочная цена &mdash; это цена предмета, которая будет показываться в библиотеке, в административных интерфейсах и т.д. В магазинах предмет может продаваться по другим ценам, не обязательно совпадающим с балансировочной. Но во всех расчётах, когда вам потребуется, например, узнать сумму денег, потраченную персонажами в бою, будет использоваться именно балансировочная цена.</li>
	<li>Описание предмета будет показываться в библиотеке и в других интерфейсах.</li>
	<li>Дополнительный CSS-класс &mdash; это строка, которая будет добавлена в атрибут class у элемента, в который помещается предмет.</li>
</ul>

<p>Чтобы сделать определённые типы предметов оформленными специальным образом, пропишите в это поле какой-либо класс. Например, можно всем артефактам прописать класс item-artefact, а затем в файле game.css игрового шаблона можно прописать ему особое оформление:</p>
<pre class="doc-code-sample">
.item-artefact .item-info-name { color: red }
</pre>
<p>В результате, названия всех артефактов будут выделены красным.</p>

<a name="categories"></a>
<h1>Рубрикаторы</h1>

<p>В инвентаре персонажа может находиться большое количество предметов. Чтобы игроку было удобнее их просматривать, имеет смысл сгруппировать их по категориям. Практика показывает, что один и тот же набор категорий не подходит для всех интерфейсов игры. К примеру, в инвентаре персонажа имеет смысл сделать раздел "Квесты", в который будут помещаться все квестовые предметы. Однако, если вы делаете игровую биржу, то сваливать предметы по всем квестам в одну кучу будет неудобно, поскольку персонаж обычно проходит не более 5 квестов, а на бирже могут продаваться предметы для всех 100 квестов, имеющихся в игре. В результате, рубрикатор для биржи должен быть другим: "Квесты в подземелье", "Курьерские квесты" и т.д. Для админки рубрикатор вообще будет третьим, т.к. зачастую удобно группировать предметы не по назначению (отдельно экипировка, отдельно расходники), а по области применения ("новый год", "день победы", "нубоквесты" и т.д)</p>

<p>В связи с этим, для каждого из игровых интерфейсов предусмотрена возможность сделать свой рубрикатор. Это делается через меню "Инвентарь/рубрикаторы": <img class="doc-screenshot" src="/st/tutorial/inventory-5.png" alt="" /></p>
<p>Каждый из рубрикаторов настраивается индивидуально. Вы можете создавать в нём любое количество категорий: <img class="doc-screenshot" src="/st/tutorial/inventory-6.png" alt="" /></p>
<p>Для каждой из категорий настраивается её название, порядок сортировки и дополнительные признаки: <img class="doc-screenshot" src="/st/tutorial/inventory-7.png" alt="" /></p>
<p>Параметр "Эта категория открывается по умолчанию" позволяет вам определить, какая вкладка будет открыта, когда игрок открывает соответствующий интерфейс (например, заходит в инвентарь). Если в этой категории нет ни одного предмета, то откроется первая по счёту вкладка.</p>
<p>Параметр "категория для всех предметов, не подходящих в другие категории" обозначает раздел "Разное". Если у вас есть предметы, которым вы ещё не успели задать категорию, то они автоматически попадут в этот раздел. Если у вас были предметы в какой-то категории, а потом вы эту категорию удалили, то эти предметы автоматически попадут в категорию "Разное". Если вы не укажете ни одной категории этот признак, то "бесхозные" предметы вообще не будут отображаться.</p>

<p>После создания рубрикатора вы можете через редактор типов предметов присвоить каждому предмету категории, к которым он относится: <img class="doc-screenshot" src="/st/tutorial/inventory-9.png" alt="" /></p>

<a name="images"></a>
<h1>Изображения предметов</h1>

<p>Через меню "Инвентарь / Конфигурация инвентаря" вы можете настроить общие параметры, касающиеся изображений. Первое, что необходимо настроить, это размеры картинок, которые должны существовать для всех предметов: <img class="doc-screenshot" src="/st/tutorial/inventory-1.png" alt="" /></p>

<p>В этом же интерфейсе необходимо указать размеры изображений для инвентаря и библиотеки.</p>

<p>Для каждого предмета вы можете загрузить изображения в нескольких размерах: <img class="doc-screenshot" src="/st/tutorial/inventory-10.png" alt="" /></p>

<p>Вы можете как заменить все изображения предмета разом (выбрав пункт "Заменить все изображения"), так и каждый размер в отдельности (выбрав пункт "Заменить отдельные изображения"). Конструктор автоматически смасштабирует и откадрирует загруженные изображения под нужные размеры.</p>

<p>При отображении предмета система попытается найти картинку, в точности равную тому размеру, в котором она должна показываться. Если точного размера не нашлось, то система попытается найти наиболее близкое по размеру, которое меньше заданного. Если и это не удалось, и все имеющиеся картинки больше, чем надо, то будет выбрано самое маленькое из доступных. Если картинок у предмета не окажется совсем, то предмет будет отображён без картинки.</p>

<a name="constraints"></a>
<h1>Ограничения грузоподъёмности персонажей</h1>

<p>Одно из ограничений &mdash; максимальное количество разных типов предметов, которые могут храниться в инвентаре одновременно, &mdash; настраивается в разделе "Инвентарь / Конфигурация инвентаря". Здесь вы можете задать выражение для вычисления количества, в зависимости от параметров персонажа. Обратите внимание, что есть техническое ограничение в 200 типов, больше которого поместить в инвентарь будет невозможно: <img class="doc-screenshot" src="/st/tutorial/inventory-2.png" alt="" /></p>

<p>Это ограничение связано с производительностью движка. Ведь при каждой загрузке инвентаря системе необходимо будет загрузить из базы данных параметры всех предметов. Чем оно будет меньше, тем выше будет скорость загрузки инвентаря в вашей игре.</p>

<p>Кроме того, вы можете задать собственный набор дополнительных ограничений на грузоподъёмность персонажа. Для этого через интерфейс "Инвентарь / Ограничения грузоподъёмности" вы можете создать любое количество правил, которые будут проверяться при попытке положить предметы в инвентарь персонажа: <img class="doc-screenshot" src="/st/tutorial/inventory-3.png" alt="" /></p>

<p>Для каждого правила вам необходимо задать три параметра: выражение для вычисления текущего груза на персонаже, выражение для вычисления максимального груза, который данный персонаж может поднять, и выражение для вычисления текста, который надо будет показать игроку, если у его персонажа будет перегруз по этому правилу: <img class="doc-screenshot" src="/st/tutorial/inventory-4.png" alt="" /></p>

<p>К примеру, если вы создадите предметам параметр "вес" (weight), а персонажам &mdash; параметр "грузоподъёмность" (max_cargo), то вы сможете создать правило для грузоподъёмности в том виде, как оно приведено на скриншоте выше. Аналогичным образом можно создать правила для "объёма", "максимального магического фона" от предметов в инвентаре и т.д. Количество правил не ограничено. Описание языка скриптов приведено в <a href="/doc/script">соответствующем разделе документации</a>.</p>

<p>Замечание. При выдаче предметов через административный интерфейс ограничения не проверяются &mdash; вы можете выдать столько предметов, сколько сочтёте нужным.</p>

<a name="fractions"></a>
<h1>Частичное количество предметов</h1>

<p>Конструктор позволяет создавать предметы, которые могут расходоваться или изнашиваться постепенно. Это может быть полезно, например, для колб с эликсирами или для экипировки, которая ломается после боя. Чтобы позволить предмету иметь частичное количество, поставьте галочку "Этот предмет делится на части": <img class="doc-screenshot" src="/st/tutorial/inventory-19.png" alt="" /></p>

<ul>
	<li>Количество частей в целом предмете &mdash; укажите любое целое число, не менее 2 и не более 1000000;</li>
	<li>названия этого параметра необходимо указать для двух интерфейсов &mdash; для новых предметов (например, если вы продаёте новые предметы в магазине, а также для библиотеки) и для предметов, которые уже попали в инвентарь к персонажу. К примеру, в библиотеке вы можете писать для предмета экипировки "Долговечность: 5", а когда предмет уже куплен игроком, то "Износ: 0 из 5";</li>
	<li>в зависимости от применения, вам может понадобиться либо отображать остаток (например для зелья это может быть "Объём: 730 из 750 мл"), либо количество использованных единиц (например: "Выпито: 20 из 750 мл"). Чтобы управлять желаемым отображением, установите либо снимите галочку "В инвентаре показывать обратное значение";</li>
	<li>единица измерения &mdash; если износ вашего предмета является безразмерной величиной ("Износ: 2 из 50"), то оставьте поле пустым. Если параметр имеет размерность (например, миллилитры, щепотки или что-то ещё), то укажите эту единицу в трёх склонениях &mdash; для 1, 2 или 5 единиц.</li>
</ul>

<p>Текущее количество использованных единиц предмета доступно через скриптовый движок при помощи атрибута "used" у предмета. Например:</p>
<pre class="doc-code-sample">item.used</pre>

<p>Максимально возможное количество долей у предмета доступно через атрибут "item.fractions", а при помощи атрибута "item.frac_ratio" можно получить полезную величину, показывающую оставшуюся долю предмета. 1 &mdash; неизношенный предмет, 0 &mdash; полностью изношенный. Для предметов, не делящихся на части, этот параметр всегда равен 1. Он может быть полезен при вычислении цены скупки товара:</p>
<pre class="doc-code-sample">price * item.frac_ratio * 0.1</pre>

<p>Атрибут "item.used" является изменяемым. При помощи <a href="/doc/quests">квестового движка</a> можно "изнашивать" или "ремонтировать" предмет:</p>
<pre class="doc-code-sample">set item.used = item.used + 1</pre>

<p>Когда износ предмета достигает максимального (или превышаюшего его) значения, он будет автоматически уничтожен.</p>

<h1>Игровые интерфейсы</h1>

<p>Чтобы в игровом интерфейсе появилась кнопка инвентаря, вам необходимо разместить её на панели кнопок через меню "Интерфейс игры / Редактор кнопок". При нажатии на эту кнопку открывается интерфейс инвентаря персонажа.</p>

<a name="templates"></a>
<p>Шаблон инвентаря находится в файле <a href="/doc/game-template/inventory.html">inventory.html</a>. Информация о том, как изменять шаблоны, приведена в разделе <a href="/doc/design/gameinterface">Игровой интерфейс</a>. Доступны следующие параметры шаблонизатора:<ul>
	<li>error &mdash; сообщение об ошибке (может отсутствовать);</li>
	<li>categories &mdash; список категорий инвентаря. Каждый элемент списка &mdash; структура:<ul>
		<li>items &mdash; список предметов в данной категории. Каждый элемент списка &mdash; структура:<ul>
			<li>image &mdash; URL изображения предмета (может отсутствовать);</li>
			<li>onclick &mdash; JavaScript-действие при нажатии на картинку предмета (может отсутствовать);</li>
			<li>name &mdash; название предмета;</li>
			<li>quantity &mdash; количество предметов в инвентаре;</li>
			<li>params &mdash; список параметров предмета. Каждый элемент списка &mdash; структура:<ul>
				<li>header &mdash; заголовок (если присутствует, то это текст заголовка. Если отсутствует, то это обычный параметр с перечисленными ниже свойствами);</li>
				<li>name &mdash; название параметра;</li>
				<li>value &mdash; значение параметра;</li>
				<li>library_icon &mdash; HTML-код ссылки на описание параметра в библиотеке (может отсутствовать);</li>
			</ul></li>
			<li>description &mdash; описание предмета (может отсутствовать);</li>
			<li>menu &mdash; меню действий над предметом. Каждый элемент списка &mdash; структура:<ul>
				<li>href &mdash; гиперссылка на пункте меню (может отсутствовать &mdash; тогда пункт будет некликабельным);</li>
				<li>onclick &mdash; действие onclick на пункте меню (может отсутствовать);</li>
				<li>html &mdash; текст пункта меню.</li>
			</ul></li>
		</ul></li>
	</ul></li>
</ul></p>

<p>HTML-представление значения параметра имеет сложную структуру. Если параметр не модифицирован, то, он выглядит просто:</p>
<pre class="doc-code-sample">
&lt;span class="item-param-value value"&gt;&lt;span class="item-types-page-weight-value"&gt;0.5&lt;/span&gt;&lt;/span&gt;
</pre>
<p>Здесь weight &mdash; это код параметра, а 0.5 &mdash; его значение у данного предмета.</p>

<p>Если параметр модифицирован, то, в зависимости от режима отображения, либо выводится итоговое модифицированное значение, либо "базовое плюс модификатор". Режим отображения настраивается в редакторе параметров. Если выбран режим показа модифицированного значения, то HTML-представление имеет вид:</p>
<pre class="doc-code-sample">
&lt;span class="item-param-value value"&gt;&lt;span class="param-mod param-mod-plus"&gt;&lt;span class="item-types-page-weight-value"&gt;2&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
</pre>
<p>Здесь значение параметра обёрнуто в дополнительный span с классами param-mod и param-mod-plus. Если параметр изменён в большую сторону, то добавляется класс param-mod-plus. Если в меньшую, то param-mod-minus.</p>
<p>Если выбрано представление "базовое значение плюс модификатор", то HTML оформляется так:</p>
<pre class="doc-code-sample">
&lt;span class="item-param-value value"&gt;&lt;span class="item-types-page-weight-value"&gt;0.5&lt;/span&gt;&lt;span class="param-mod param-mod-plus"&gt;+1.5&lt;/span&gt;&lt;/span&gt;
</pre>
<p>В этом случае классами param-mod и param-mod-plus обёрнуто только прибавленное значение: "+1.5".</p>
<p>Изменяя CSS-классы param-mod-plus и param-mod-minus, вы можете настроить оформление модифицированных параметров.</p>

<h1>Библиотека</h1>

<p>Общая информация о настройке библиотеки приведена в разделе <a href="/doc/library">Структура библиотеки игры</a>. При подключении модуля инвентаря в библиотеке автоматически появляются разделы "Параметры предметов" (/library/itemparams) и "Каталог предметов" (/library/items).</p>

<p>В разделе "Параметры предметов" приводятся описания всех параметров, для которых разрешена публикация информации о них в библиотеке. В этом случае рядом со значениями этих параметров в игровых интерфейсах появляется ссылка на библиотеку.</p>

<p>В разделе "Каталог предметов" отображается рубрикатор библиотеки, через который можно посмотреть список предметов в каждой из категорий. Для предметов показываются все параметры, которые отмечены в редакторе параметров как "Видимые владельцу". То есть, библиотека не скрывает ничего, что может увидеть владелец предмета. Размер изображений в библиотеке показывается такой, какой настроен через конфигуратор инвентаря &mdash; см. раздел <a href="#images">Изображения предметов</a>.</p>

<p>Если вы хотите изменить стандартный вид страниц библиотеки, касающихся инвентаря, вам понадобится исправить следующие шаблоны социального интерфейса:<ul>
	<li><a href="/doc/socio-template/library-itemparams.html">library-itemparams.html</a> &mdash; список параметров предметов;</li>
	<li><a href="/doc/socio-template/library-itemparam.html">library-itemparam.html</a> &mdash; таблица значений одного параметра предмета;</li>
	<li><a href="/doc/socio-template/library-itemcategories.html">library-itemcategories.html</a> &mdash; список категорий рубрикатора предметов;</li>
	<li><a href="/doc/socio-template/library-items.html">library-items.html</a> &mdash; список предметов. Параметры шаблона аналогичны приведённым выше параметрам для inventory.html.</li>
</ul></p>

<h1>Админка по инвентарю</h1>

<p>Система инвентаря добавляет следующие привилегии:<ul>
	<li>Инвентарь: конфигурация &mdash; доступ к основным настройкам системы инвентаря;</li>
	<li>Инвентарь: редактор типов предметов &mdash; право создавать и изменять типы предметов, менять им параметры;</li>
	<li>Инвентарь: отслеживание предметов &mdash; доступ к просмотру инвентаря других персонажей и к истории операций с предметами в игре;</li>
	<li>Инвентарь: выдача предметов &mdash; право выдавать предметы через админку;</li>
	<li>Инвентарь: изъятие предметов &mdash; право отнимать предметы у персонажей через админку.</li>
</ul></p>

<p>Чтобы посмотреть содержимое инвентаря какого-то персонажа, откройте его досье, перейдите на вкладку "Предметы" и выберите пункт "Просмотр инвентаря": <img class="doc-screenshot" src="/st/tutorial/inventory-11.png" alt="" /></p>

<p>Ссылки "передать" и "изъять" открывают соответствующие интерфейсы по передаче предмета другому персонажу и по изъятию предметов из инвентаря: <img class="doc-screenshot" src="/st/tutorial/inventory-12.png" alt="" /></p>

<a name="history"></a>
<p>При нажатии на название предмета откроется интерфейс просмотра истории предметов данного типа у данного персонажа: <img class="doc-screenshot" src="/st/tutorial/inventory-13.png" alt="" /></p>

<p>Обратите внимание на колонку "Модификаторы". Если предмет модифицирован, то в ней пишется ДНК-суффикс предмета. Если объединить тип предмета и его ДНК-суффикс через знак "_", то получится полный ДНК предмета. Когда модифицированный предмет помещается в инвентарь, то в логе будет написан не только его ДНК-суффикс, но и полная расшифровка модифицированных параметров предмета. При изъятии предмета пишется только его ДНК-суффикс. Срок годности в поле "до" пишется по времени UTC.</p>

<p>Просмотр истории предметов может работать в 3 режимах:<ul>
	<li>отображение истории по операциям с конкретным предметом у конкретного персонажа;</li>
	<li>отображение истории по операциям с конкретным предметов у всех персонажей;</li>
	<li>отображение истории по операциям по всем предметам у конкретного персонажа.</li>
</ul></p>

<p>Переключение между ними осуществляется по нажатиям на значения в столбцах "Владелец" и "Тип предмета". История предметов показывается не вся сразу с постраничной прокруткой, а по интервалам. Первый режим показывает операции с месячным интервалом, а второй и третий &mdash; с суточным. У администратора имеется возможность переходить вперёд и назад по ленте времени при помощи ссылок "Раньше" и "Позже".</p>

<p>Если была произведена операция по передаче предметов, то в графе "Референс" отображается ссылка на имя другого персонажа (или иного хранилища предметов): <img class="doc-screenshot" src="/st/tutorial/inventory-14.png" alt="" /></p>

<p>При нажатии на эту ссылку откроется история предметов у связанного персонажа с интервалом времени, установленным ровно в ту же секунду, когда была произведена операция: <img class="doc-screenshot" src="/st/tutorial/inventory-15.png" alt="" /></p>

<p>Когда производится единая операция по одновременному обмену несколькими видами предметов (например, торговая сделка), система установит на них одинаковое время, и это позволит при помощи ссылки "Референс" увидеть всю торговую сделку на одном экране. Если администратор хочет расширить интервал времени с единственной секунды до всех суток, то он должен воспользоваться ссылкой "Текущий период".</p>

<p>Для выдачи предметов администратор должен воспользоваться функцией "Выдать предметы" на вкладке "Предметы" в досье персонажа, либо ссылкой "Выдать" в списке типов предметов. Первая из них имеет упрощённый интерфейс для массовой выдачи предметов одному персонажу. Администратор перечисляет предметы, которые нужно выдать, с новой строки, и разом выдаёт их получателю. Вторая позволяет выдавать модифицированные версии предметов, изменяя у выданных экземпляров любые характеристики.</p>

<h1>Срок годности</h1>

<p>Предметы в игре могут обладать сроком годности. Редактор сроков годности находится в редакторе типов предметов: <img class="doc-screenshot" src="/st/tutorial/inventory-16.png" alt="" /></p>

<p>Чтобы задать предмету срок годности конкретной датой (к примеру, если вы делаете событие к Новому Году, то выданные предметы должны будут удалиться, скажем, в конце января), выберите пункт "Абсолютное время" и задайте дату в формате "DD.MM.YYYY HH:MM:SS" или в формате "DD.MM.YYYY". Если вы указываете дату без времени, то считается, что предмет будет жить до этой даты включительно (до 23:59:59): <img class="doc-screenshot" src="/st/tutorial/inventory-17.png" alt="" /></p>

<p>Однако, основным режимом установки срока годности у вас будет его установка в виде интервала с момента создания предмета. Для этого выберите пункт "Интервал" и укажите время в секундах, сколько должен существовать предмет. Полезные значения &mdash; 86400 (сутки), 604800 (неделя), 2592000 (месяц).</p>

<p>Со сроком годности в виде интервала есть один нюанс, связанный с группировкой одинаковых предметов в стопки. Если у предметов разный срок годности (отличающийся хотя бы на секунду), то предметы попадут в разные стопки. А если игрок за время прохождения квеста наберёт, скажем, 50 таких предметов, и у всех будет разный срок годности, то они займут 50 мест в инвентаре. Кроме того, что это неудобно для игрока, вы можете быстро упереться в <a href="#constraints">ограничение грузоподъёмности</a> по количеству стопок. Чтобы этого избежать, существует настройка округления срока годности. При выдаче предмета его срок годности будет сначала рассчитываться прибавлением к текущему времени указанного вами интервала, а затем увеличиваться до ближайшего круглого значения. Грубость округления вы выбираете сами &mdash; сутки, неделя или месяц. Если выбран режим "сутки", то срок годности предметов будет округляться до 23:59:59 дня, в котором должен исчезнуть предмет. Если "неделя", то срок округляется до конца воскресенья. Если "месяц", то до последнего числа месяца. Поскольку округлённые сроки годности будут совпадать у множества предметов, то они (предметы) будут складываться в стопки и не будут занимать ценные ячейки инвентаря.</p>

<p>Все даты хранятся в базе данных в часовом поясе UTC. Округление осуществляется в момент выдачи предметов, в соответствии с часовым поясом, в котором работает игра. Если после выдачи предмета часовой пояс сменится, то "съедут" и сроки годности предметов. Отображение сроков годности всегда осуществляется в часовом поясе игры. Административные интерфейсы также показывают все операции в соответствии с часовым поясом игры.</p>

<p>При отображении сроков годности, заканчивающихся на "23:59:59", время автоматически скрывается ради компактности.</p>

<h1>Скриптинг</h1>

<p>Общее описание скриптового движка приведено на странице <a href="/doc/script">Скриптовый движок</a>.</p>

<p>У персонажа есть поле "inv", который ссылается на объект Inventory, предоставляющий доступ к его инвентарю. Объект Inventory позволяет запросить агрегированные данные по параметрам предметов, имеющихся в инвентаре. У инвентаря есть поля:<ul>
	<li>max_<strong>параметр</strong> &mdash; максимальное значение параметра "<strong>параметр</strong>", какое только встречается у предметов в инвентаре;</li>
	<li>min_<strong>параметр</strong> &mdash; минимальное значение параметра "<strong>параметр</strong>";</li>
	<li>sum_<strong>параметр</strong> &mdash; суммарное значение параметра "<strong>параметр</strong>" у всех предметов, имеющихся в инвентаре;</li>
	<li>cnt_<strong>тип</strong> &mdash; количество предметов типа "<strong>тип</strong>", имеющихся в инвентаре (независимо от того, имеют они модификации или нет);</li>
	<li>cnt_dna_<strong>ДНК</strong> &mdash; количество предметов с ДНК, в точности равным "<strong>ДНК</strong>", имеющихся в инвентаре.</li>
</ul></p>

<p>К примеру, чтобы посчитать суммарный вес (параметр "weight") всех предметов в инвентаре персонажа, необходимо написать:</p>
<pre class="doc-code-sample">char.inv.sum_weight</pre>
<p>Чтобы разрешить вход в локацию только персонажам, имеющим ключ в инвентаре (допустим, у ключа тип 2378568376459823698263), в условие перехода необходимо прописать:</p>
<pre class="doc-code-sample">char.inv.cnt_2378568376459823698263</pre>
<p>а в сообщение об отказе: "Сюда могут войти только обладатели ключа".</p>

<a name="object"></a>
<h2>Объект Item</h2>

<p>Объект Item предоставляет доступ через скриптовый движок к параметрам предмета:</p>
<ul>
	<li>id &mdash; идентификатор предмета;</li>
	<li>type &mdash; тип предмета;</li>
	<li>dna &mdash; ДНК предмета;</li>
	<li>name &mdash; название предмета;</li>
	<li>name_gp &mdash; название предмета в родительном падеже и множественном числе;</li>
	<li>name_a &mdash; название предмета в винительном падеже;</li>
	<li>p_<strong>код</strong> &mdash; значение параметра с указанным кодом;</li>
	<li>equip &mdash; равен 1, если предмет надеваемый и 0, если не надеваемый (см. описание <a href="/doc/equip">модуля экипировки</a>);</li>
	<li>used &mdash; количество единиц износа (см. описание <a href="#fractions">частичного количества</a>);</li>
	<li>fractions &mdash; максимальное количество единиц износа (см. описание <a href="#fractions">частичного количества</a>);</li>
	<li>frac_ratio &mdash; оставшаяся доля предмета (см. описание <a href="#fractions">частичного количества</a>).</li>
</ul>

<p>При вызове событий, которым передаётся параметр item, атрибут p_<strong>код</strong> становися изменяемым. При его изменении изменяются свойства только одного экземпляра этого предмета. Когда вызывается событие equip-wear или equip-unwear из <a href="/doc/equip">модуля экипировки</a>, будут изменяться характеристики надетых в соответствующие слоты предметов.</p>

<h1>Дополнительно</h1>

<ul>
	<li><a href="/doc/script">Описание скриптового движка</a></li>
	<li><a href="/doc/library">Описание настройки библиотеки</a></li>
	<li><a href="/doc/design/gameinterface">Настройка оформления игры</a></li>
	<li><a href="/doc/equip">Экипировка персонажей</a></li>
</ul>
