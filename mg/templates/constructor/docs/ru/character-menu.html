<!-- doc.title Контекстное меню персонажа в конструкторе онлайн-игр -->
<!-- doc.parent index -->
<!-- doc.keywords персонаж, меню, онлайн-игра -->
<!-- doc.description Статья о настройке контекстного меню для персонажей в конструкторе онлайн-игр -->

<p>При нажатии правой кнопки мыши на имени персонажа может выпадать контекстное меню персонажа, гибко настраиваемое администратором игры.</p>

<h1>Настройка контекстного меню</h1>

<p>Чтобы открыть редактор контекстного меню, зайдите в административный интерфейс в пункт меню "Персонажи / Контекстное меню персонажа": <img class="doc-screenshot" src="/st/tutorial/charcontext-1.png" alt="" /></p>

<p>Добавляя новый элемент меню (по ссылке "Новый элемент меню") или редактируя существующий, администратор заполняет следующую форму: <img class="doc-screenshot" src="/st/tutorial/charcontext-2.png" alt="" /></p>

<ul>
    <li>текст элемента &mdash; это текст, который будет показан пользователю. В нём допустимо использовать скриптовые вставки;</li>
    <li>порядок сортировки &mdash; число, по которому сортируются пункты меню для показа пользователю;</li>
    <li>условие видимости &mdash; скриптовое условие, определяющее видимости пункта меню персонажу;</li>
    <li>иконка меню &mdash; картинка, которая будет показываться рядом с элементом меню;</li>
    <li>действие элемента меню &mdash; есть варианты:<ul>
        <li>открыть гиперссылку &mdash; в новой вкладке будет открыт указанный администратором URL (допустимы скриптовые вставки);</li>
        <li>выполнить JavaScript-код &mdash; в браузере игрока будет выполнена указанная команда (допустимы скриптовые вставки);</li>
        <li>вызвать квестовое событие &mdash; на сервер будет отправлена команда, по которой на сервере сработает <a href="/doc/quests#clicked">событие "clicked"</a> с указанным кодом (в коде допустимы скриптовые вставки). В скриптовый обработчик будет передана глобальная переменная "targetchar", по которой будет доступен персонаж, меню которого открывалось.</li>
    </ul></li>
</ul>

<p>Всем скриптовым выражениям доступны следующие глобальные переменные:<ul>
    <li>char &mdash; персонаж, меню которого открыто;</li>
    <li>viewer &mdash; персонаж, от имени которого просматривается меню.</li>
</ul></p>

<p>Все скрипты, относящиеся к контекстному меню, выполняются не на сервере, а в браузере игрока. В связи с этим, не все параметры персонажей доступны для использования. В браузер передаются следующие параметры персонажей:<ul>
    <li>name &mdash; имя персонажа;</li>
    <li>sex &mdash; пол персонажа (0=мужской, 1=женский);</li>
    <li>combat &mdash; идентификатор боя, в котором в данный момент участвует персонаж;</li>
    <li>p_* &mdash; доставляемые пользовательские параметры (см. раздел <a href="/doc/character-delivery">Доставка параметров персонажей</a>).</li>
</ul></p>

<h1>Примеры полезных элементов меню</h1>

<h2>Открыть досье</h2>

<p>Предварительно заведите параметр персонажа "admin", вычисляемый по скриптовому выражению:</p>
<pre class="doc-code-sample">
char.anyperm ? 1 : 0
</pre>

<p>Сделайте этот параметр <a href="/doc/character-delivery">доставляемым в клиент</a>, а затем через редактор меню персонажа сделайте пункт с условием видимости для администраторов:</p>
<pre class="doc-code-sample">
viewer.p_admin
</pre>

<p>При выборе пункта меню выберите действие "Открыть гиперссылку":</p>
<pre class="doc-code-sample">
/admin#auth/user-dashboard/{char.id}?active_tab=dossier
</pre>

<h2>Доступ к молчанкам</h2>

<p>Предварительно заведите параметр персонажа "admin", как в предыдущем разделе. Затем пропишите условие для пункта меню:</p>
<pre class="doc-code-sample">
viewer.p_admin
</pre>

<p>При выборе пункта меню выберите действие "Открыть гиперссылку":</p>
<pre class="doc-code-sample">
/admin#restraints/add/{char.id}/chat-silence
</pre>

<h2>Нападение на персонажа</h2>

<p>Пропишите условие видимости пункта меню "Напасть":</p>
<pre class="doc-code-sample">
not char.combat and not viewer.combat and char.id != viewer.id
</pre>

<p>При выборе пункта меню выберите действие "Вызвать квестовое событие":</p>
<pre class="doc-code-sample">
attack
</pre>

<p>Обработчик события может выглядеть так:</p>
<pre class="doc-code-sample">
clicked "attack" {
  if char.id != targetchar.id {
    if char.location and targetchar.location and char.location.id == targetchar.location.id {
      combat rules="test3" ctitle="{char.name} [char.sex:напал,напала] на {targetchar.name}" flags="pvp" {
        member char team=1
        member targetchar team=2
      }
    } else {
      error "{targetchar.name} в другой локации"
    }
  }
}
</pre>

<h1>Дополнительно</h1>
<ul>
	<li><a href="/doc/script">Скриптовый движок</a></li>
</ul>
