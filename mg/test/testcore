#!/usr/bin/python2.6
# -*- coding: utf-8 -*-

import unittest
from concurrence import dispatch, Tasklet

from mg.core import *
from mg.stor.db import DatabasePool
from mg.stor.mc import Memcached

class TestMemcached(unittest.TestCase):
    def setUp(self):
        pass

    def test(self):
        self.app = Application(inst=Instance(), dbpool=DatabasePool(), keyspace="mgtest", mc=Memcached(prefix="mgtest_"))
        list = []
        self.app.hooks.call("core.loaded_modules", list)
        self.assertEqual(len(list), 0)

        self.app.modules.load(["test.Test1"])
        list = []
        self.app.hooks.call("core.loaded_modules", list)
        self.assertEqual(len(list), 1)
        self.assertEqual(list[0], "test.Test1")

        self.app.modules.load(["db.CommonDatabaseStruct"])
        dbstruct = {}
        self.app.hooks.call("database.struct", dbstruct)
        self.assertTrue(len(dbstruct) > 0)
        self.assertTrue("Config" in dbstruct)
        self.assertTrue("Hooks" in dbstruct)
        self.app.hooks.call("database.apply", dbstruct)

if __name__ == "__main__":
    dispatch(unittest.main)
